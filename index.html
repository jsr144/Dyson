<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Curiosity Explorer: For Mary's Science Fair Birthday!</title>
    <style>
        /* Basic variables and styles */
        :root {
            --primary: #6d28d9; /* Deep Purple */
            --secondary: #ec4899; /* Bright Pink */
            --accent: #f59e0b; /* Amber */
            --light: #fdf2f8; /* Very Light Pink */
            --dark: #1e1b4b; /* Dark Indigo */
            --success: #10b981; /* Emerald Green */
            --info: #3b82f6; /* Blue */
            --white: #ffffff;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; /* Fun, kid-friendly font */
            line-height: 1.6;
            color: var(--dark);
            background-color: var(--light);
            background-image: linear-gradient(120deg, #fdf2f8 0%, #e0f2fe 100%); /* Light gradient background */
            margin: 0;
            padding: 1rem; /* Added padding for smaller screens */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Main content container */
        .container {
            width: 90%;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border: 3px dashed var(--secondary); /* Dashed pink border */
        }

        /* Headings */
        h1, h2, h3 {
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }

        h1 {
            margin-bottom: 1.5rem;
            font-size: 2.2rem; /* Slightly smaller for better fit */
            background: linear-gradient(120deg, var(--primary), var(--secondary)); /* Gradient text */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* Use transparent text color to show gradient */
            -webkit-text-fill-color: transparent; /* For Safari */
        }

        h2 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.6rem; /* Slightly smaller */
            color: var(--secondary);
        }

        h3 {
             font-size: 1.3rem;
        }

        /* Paragraphs */
        p {
            margin-bottom: 1rem;
            font-size: 1rem; /* Slightly smaller for conciseness */
        }

        /* Birthday Banner */
        .birthday-banner {
            text-align: center;
            padding: 0.8rem; /* Reduced padding */
            background-color: rgba(236, 72, 153, 0.1); /* Light pink background */
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .birthday-banner p {
            font-size: 1.1rem; /* Slightly smaller */
            font-weight: bold;
            color: var(--secondary);
            margin: 0;
        }

        /* Game Sections */
        .game-section {
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Smooth transition */
        }

        .game-section.active {
            display: block; /* Show active section */
            opacity: 1;
            transform: translateY(0);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.7rem 1.4rem; /* Slightly smaller padding */
            margin: 0.5rem 0.25rem;
            border-radius: 50px; /* Rounded pill shape */
            font-size: 0.95rem; /* Slightly smaller font */
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit; /* Use body font */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary);
            transform: translateY(-3px) scale(1.05); /* Lift and scale effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background-color: #cccccc; /* Grey out disabled buttons */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-next { background-color: var(--accent); float: right; }
        .btn-prev { background-color: var(--info); float: left; }
        .btn-submit { background-color: var(--success); display: block; margin: 1rem auto; }
        .btn-restart { background-color: var(--primary); display: block; margin: 1rem auto; }
        .btn-email { background-color: var(--info); display: block; margin: 1rem auto; } /* Style for email button */


        /* Options for multiple choice */
        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Better spacing */
            margin: 1.5rem 0;
        }

        .option {
            flex-basis: calc(50% - 1rem); /* Two columns with gap */
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: rgba(59, 130, 246, 0.1); /* Light blue background */
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Include padding and border in width */
        }

        .option:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: var(--info);
            transform: translateY(-3px);
        }

        .option.selected { background-color: rgba(236, 72, 153, 0.2); border-color: var(--secondary); }
        .option.correct { background-color: rgba(16, 185, 129, 0.2); border-color: var(--success); cursor: default; }
        .option.incorrect { background-color: rgba(245, 158, 11, 0.2); border-color: var(--accent); cursor: default; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; } /* Style for disabled options after answering */

        /* Feedback messages */
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 15px;
            display: none; /* Hidden by default */
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
        }

        .feedback.correct { background-color: rgba(16, 185, 129, 0.1); border-left-color: var(--success); display: block; }
        .feedback.incorrect { background-color: rgba(245, 158, 11, 0.1); border-left-color: var(--accent); display: block; }

        /* Score Display */
        .score-display {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* Cosmic Sphere Visualization */
        .cosmic-sphere-container {
            position: relative;
            width: 250px; /* Smaller size */
            height: 250px;
            margin: 1.5rem auto; /* Reduced margin */
            perspective: 1000px; /* For 3D effects if needed */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .star {
            position: absolute;
            width: 80px; /* Smaller star */
            height: 80px;
            background: radial-gradient(circle, #FFDA63, #FF9800); /* Brighter yellow gradient */
            border-radius: 50%;
            box-shadow: 0 0 25px 8px rgba(255, 193, 7, 0.6); /* Adjusted shadow */
            z-index: 1; /* Star is behind elements */
        }

        .cosmic-ring {
            position: absolute;
            border: 4px dashed rgba(236, 72, 153, 0.7); /* Dashed ring */
            border-radius: 50%;
            width: 150px; /* Ring size */
            height: 150px;
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.5);
            animation: rotate 20s linear infinite;
            z-index: 2; /* Ring above star */
            opacity: 0; /* Initially hidden */
            transition: opacity 0.5s ease-in-out;
        }

        .cosmic-panel {
            position: absolute;
            width: 20px;
            height: 30px;
            background-color: rgba(109, 40, 217, 0.6); /* Semi-transparent purple */
            border: 1px solid rgba(109, 40, 217, 0.9);
            border-radius: 4px;
            transform-origin: center;
            box-shadow: 0 0 5px rgba(109, 40, 217, 0.5);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0; /* Initially hidden */
            z-index: 3; /* Panels above ring */
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: rgba(59, 130, 246, 0.2);
            border-radius: 50px;
            margin-bottom: 1rem;
            overflow: hidden;
            height: 15px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        /* Clearfix for floated elements */
        .clearfix::after { content: ""; clear: both; display: table; }

        /* Resource Counter */
        .resource-counter {
            font-size: 1rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        .resource-animation { animation: pulse 0.5s ease-in-out; }

        /* Wall of Facts */
        .wall-of-facts {
            background-color: rgba(16, 185, 129, 0.1); /* Light green background */
            border-radius: 15px;
            padding: 1rem;
            margin: 1.5rem 0;
            max-height: 300px;
            overflow-y: auto; /* Scroll if content overflows */
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .wall-of-facts h3 {
            color: var(--success);
            text-align: center;
            border-bottom: 2px dashed var(--success);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        .wall-of-facts ul { list-style-type: none; padding: 0; }

        .wall-of-facts li {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background-color: var(--white);
            border-radius: 10px;
            border-left: 3px solid var(--success);
            font-size: 0.9rem; /* Slightly smaller text */
            word-wrap: break-word; /* Prevent long text overflow */
        }
        .wall-of-facts li.not-fact {
             border-left-color: var(--info); /* Different color for non-facts */
        }


        .fact-attribution {
            font-style: italic;
            font-size: 0.75rem; /* Smaller attribution */
            color: var(--primary);
            margin-top: 0.3rem;
            display: block; /* Ensure it's on its own line */
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--primary);
            font-size: 0.95rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.7rem; /* Slightly smaller padding */
            border-radius: 10px;
            border: 2px solid rgba(109, 40, 217, 0.3);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Include padding in width */
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea { min-height: 80px; resize: vertical; }

        .input-hint {
            font-size: 0.75rem; /* Smaller hint text */
            color: var(--secondary);
            margin-top: 0.3rem;
        }

        /* Congratulations Container */
        .congrats-container { text-align: center; margin: 2rem 0; }

        /* Confetti Animation */
        .confetti-container {
            position: fixed; /* Cover the whole screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks through */
            overflow: hidden;
            z-index: 1000; /* Above everything */
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: var(--secondary);
            opacity: 0.7;
            animation: confetti-fall 3s linear infinite;
        }
        .confetti.c1 { background-color: var(--primary); animation-duration: 3.5s; }
        .confetti.c2 { background-color: var(--accent); animation-duration: 2.5s; }
        .confetti.c3 { background-color: var(--success); animation-duration: 4s; }
        .confetti.c4 { background-color: var(--info); animation-duration: 3.2s; }


        /* Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 16px; /* Slightly smaller */
            height: 16px;
            accent-color: var(--primary); /* Style the checkmark color */
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 0.85rem; /* Smaller label */
            color: var(--primary);
            margin-bottom: 0; /* Override default label margin */
            font-weight: normal; /* Normal weight */
            cursor: pointer;
        }

        /* Sparkle Effect */
        .sparkle { display: inline-block; animation: sparkle 1.5s infinite ease-in-out; }

        /* Mary Says Quote Box */
        .mary-says {
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 15px 15px 0;
            font-style: italic;
            font-size: 0.9rem;
        }

        /* Keyframe Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); } /* Smaller pulse */
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; } /* Adjusted sparkle */
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container { padding: 1rem; width: 95%; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            p { font-size: 0.95rem; }
            .option { flex-basis: 100%; } /* Stack options vertically */
            .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
            .cosmic-sphere-container { width: 200px; height: 200px; }
            .star { width: 60px; height: 60px; }
            .cosmic-ring { width: 120px; height: 120px; }
        }

    </style>
</head>
<body>
    <div class="confetti-container" id="confettiContainer"></div>

    <div class="container">
        <div class="birthday-banner">
            <p><span class="sparkle">✨</span> For Mary's Birthday Science Fair! <span class="sparkle">✨</span></p>
        </div>

        <h1>Cosmic Curiosity Explorer</h1>
        <p class="score-display">Fun Points: <span id="score">0</span></p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="game-section active" id="intro">
            <h2>Welcome, Science Fair Explorer!</h2>
            <p>You've found an exhibit on the <strong>Dyson Sphere</strong> - a giant structure around a star to capture its energy!</p>
            <div class="mary-says">
                "This is the year my dreams will come true (why not?)" - Mary
            </div>
            <p>In this adventure, you'll:</p>
            <ul>
                <li>Learn about this huge cosmic idea.</li>
                <li>Share your thoughts and questions.</li>
                <li>See what others wondered.</li>
                <li>Add to our Wall of Good Facts!</li>
            </ul>
            <p class="resource-counter">Curiosity Points: <span id="resources-intro">100</span></p>
            <div class="clearfix">
                <button class="btn btn-next" onclick="showSection('concept')">Let's Get Curious! →</button>
            </div>
        </div>

        <div class="game-section" id="concept">
            <h2>What's a Dyson Sphere?</h2>
            <div class="cosmic-sphere-container" id="conceptContainer">
                <div class="star"></div>
                </div>
            <p>In 1960, Freeman Dyson imagined advanced civilizations building huge structures around stars to catch ALL their energy.</p>
            <p>What form did Dyson suggest this might take?</p>
            <div class="options" id="concept-options">
                <div class="option" onclick="selectOption(this, 'concept', false)">A solid shell around a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', true)">A swarm of collectors orbiting a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A giant space vacuum for star energy.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A magic sphere to make stars last forever.</div>
            </div>
            <div class="feedback" id="concept-feedback">
                </div>
            <div class="form-group" id="concept-response" style="display: none;">
                <label for="concept-thought">Your thoughts/questions on this concept:</label>
                <textarea id="concept-thought" placeholder="e.g., This reminds me of... / I wonder if..."></textarea>
                 <div class="checkbox-container">
                    <input type="checkbox" id="concept-fact-check">
                    <label for="concept-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                </div>
                <button class="btn btn-submit" onclick="submitResponse('concept')">Add to Collection</button>
            </div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('intro')">← Back</button>
                <button class="btn btn-next" id="concept-next" style="display: none;" onclick="showSection('feasibility'); addCosmicRing();">Explore Feasibility →</button>
            </div>
        </div>

        <div class="game-section" id="feasibility">
            <h2>Could We Build One?</h2>
             <div class="cosmic-sphere-container" id="feasibilityContainer">
                <div class="star"></div>
                 </div>
            <p>What's the biggest challenge in building a Dyson Swarm?</p>
            <div class="options" id="feasibility-options">
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting the star's permission.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Inventing super-efficient solar panels.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', true)">Getting enough building materials.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting all countries to agree.</div>
            </div>
            <div class="feedback" id="feasibility-feedback">
                 </div>
            <div class="form-group" id="feasibility-response" style="display: none;">
                <label for="feasibility-thought">Ideas to solve the building challenge?</label>
                <textarea id="feasibility-thought" placeholder="e.g., Maybe we could use... / What if we tried..."></textarea>
                 <div class="checkbox-container">
                    <input type="checkbox" id="feasibility-fact-check">
                    <label for="feasibility-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                </div>
                <button class="btn btn-submit" onclick="submitResponse('feasibility')">Add to Collection</button>
            </div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('concept')">← Back</button>
                <button class="btn btn-next" id="feasibility-next" style="display: none;" onclick="showSection('importance'); addMorePanels();">Why Bother? →</button>
            </div>
        </div>

        <div class="game-section" id="importance">
            <h2>Why Is It Important?</h2>
             <div class="cosmic-sphere-container" id="importanceContainer">
                <div class="star"></div>
                 </div>
            <p>Even if hard to build, why is the Dyson Sphere concept useful?</p>
            <div class="options" id="importance-options">
                <div class="option" onclick="selectOption(this, 'importance', false)">It's a great space umbrella.</div>
                <div class="option" onclick="selectOption(this, 'importance', true)">It represents ultimate energy capture.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It's mainly for sci-fi stories.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It helps send messages to aliens.</div>
            </div>
            <div class="feedback" id="importance-feedback">
                 </div>
            <div class="form-group" id="importance-response" style="display: none;">
                <label for="importance-thought">What would YOU do with that much energy?</label>
                <textarea id="importance-thought" placeholder="e.g., I would power... / Imagine if we could..."></textarea>
                 <div class="checkbox-container">
                    <input type="checkbox" id="importance-fact-check">
                    <label for="importance-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                </div>
                <button class="btn btn-submit" onclick="submitResponse('importance')">Add to Collection</button>
            </div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('feasibility')">← Back</button>
                <button class="btn btn-next" id="importance-next" style="display: none;" onclick="showSection('build'); completeDysonSwarmVisual();">Build Your Own! →</button>
            </div>
        </div>

        <div class="game-section" id="build">
            <h2>Build Your Mini Cosmic Structure!</h2>
            <div class="cosmic-sphere-container" id="buildContainer">
                <div class="star"></div>
                </div>
            <p>You have <span id="resources-build-display">100</span> Curiosity Points. Spend them wisely!</p>
            <div class="options build-options"> <button class="btn build-btn" id="btn-satellites" onclick="allocateResources('satellites', 20)">Add Collectors (-20)</button>
                <button class="btn build-btn" id="btn-energy" onclick="allocateResources('energy', 30)">Improve Energy Capture (-30)</button>
                <button class="btn build-btn" id="btn-transmission" onclick="allocateResources('transmission', 25)">Better Transmission (-25)</button>
                <button class="btn build-btn" id="btn-stability" onclick="allocateResources('stability', 35)">Enhance Stability (-35)</button>
            </div>
            <p>Energy Collected: <span id="energy-collected">0</span>%</p>
            <p class="resource-counter">Points Left: <span id="resources-build">100</span></p>

            <div class="form-group" id="build-response"> <label for="build-thought">Share a "Good Fact" or cosmic curiosity for Mary's Wall:</label>
                <textarea id="build-thought" placeholder="e.g., A cool fact is... / I wonder about..."></textarea>
                <div class="checkbox-container">
                    <input type="checkbox" id="build-fact-check">
                    <label for="build-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                </div>
                <button class="btn btn-submit" onclick="submitResponse('build')">Add to Wall of Facts</button>
            </div>

            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('importance')">← Back</button>
                <button class="btn btn-next" id="build-next" onclick="showSection('conclusion'); finalizeResults();">See Contributions →</button>
            </div>
        </div>

        <div class="game-section" id="conclusion">
            <div class="congrats-container">
                <h2>Thanks for Exploring, <span id="display-name">Explorer</span>!</h2>
                <p>Final Fun Points: <span id="final-score">0</span></p>
                <p>Your Energy Collection: <span id="final-energy">0</span>%</p>
            </div>

            <div class="wall-of-facts">
                <h3>Wall of Good Facts & Cosmic Curiosities</h3>
                <p style="text-align: center; font-size: 0.9em;">Contributions from Mary's Science Fair:</p>
                <ul id="fact-wall">
                    </ul>
            </div>

            <div class="form-group">
                <label for="name-input">Your Name (for the Wall):</label>
                <input type="text" id="name-input" placeholder="Your Name">

                <label for="final-thought">Birthday wishes or final thoughts for Mary?</label>
                <textarea id="final-thought" placeholder="e.g., Happy Birthday Mary! / This was fun!"></textarea>
                <div class="checkbox-container">
                     <input type="checkbox" id="final-fact-check">
                     <label for="final-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                 </div>
                <button class="btn btn-submit" onclick="submitFinalThought()">Submit & Celebrate!</button>
            </div>

            <div class="mary-says">
                "Science fair is an invitation to follow your curiosity. The point is JOY, so only do this if it feels fun!" - Mary
            </div>

            <button class="btn btn-email" onclick="generateMailtoLink()">Email Results (Opens Email App)</button>
            <button class="btn btn-restart" onclick="restartGame()">Start Over</button>
        </div>
    </div>

    <script>
        // --- Constants ---
        const LOCAL_STORAGE_KEY = 'cosmicFacts'; // Key for localStorage
        const MAX_PANELS = 12; // Max panels for visualization
        const STARTER_FACTS = [ // Default facts if localStorage is empty
            { text: "Our sun makes enough energy in 1 second for humanity's needs for 500,000 years!", name: "Mary", isFact: true },
            { text: "Could Dyson Spheres create artificial habitats?", name: "Science Friend", isFact: false },
            { text: "What if we connected Dyson Spheres around multiple stars?", name: "Cosmic Explorer", isFact: false },
            { text: "A space elevator could make building cheaper!", name: "Space Engineer", isFact: false }
        ];


        // --- State Variables ---
        let score = 0;
        let currentResources = 100;
        let energyCollected = 0;
        let userName = "Explorer"; // Default name
        let buildAllocations = {
            satellites: 0, energy: 0, transmission: 0, stability: 0
        };
        // Keep track of answered questions and submitted responses for each section
        let sectionState = {
            'concept': { answered: false, submitted: false },
            'feasibility': { answered: false, submitted: false },
            'importance': { answered: false, submitted: false },
            'build': { submitted: false },
            'final': { submitted: false }
        };
        // Store all collected responses/facts - ** Loaded from localStorage **
        let collectedResponses = [];

        // --- DOM Elements (cache them) ---
        const scoreDisplay = document.getElementById('score');
        const progressBar = document.getElementById('progressBar');
        const factWall = document.getElementById('fact-wall');
        const nameInput = document.getElementById('name-input');
        const finalThoughtInput = document.getElementById('final-thought');
        const displayName = document.getElementById('display-name');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalEnergyDisplay = document.getElementById('final-energy');
        const resourcesBuildDisplay = document.getElementById('resources-build');
        const resourcesBuildCounter = document.getElementById('resources-build-display');
        const energyCollectedDisplay = document.getElementById('energy-collected');
        const confettiContainer = document.getElementById('confettiContainer');

        // --- localStorage Functions ---
        function loadFactsFromStorage() {
            const storedFacts = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedFacts) {
                try {
                    const parsedFacts = JSON.parse(storedFacts);
                    if (Array.isArray(parsedFacts)) {
                        return parsedFacts;
                    } else {
                        console.warn("Stored facts data is not an array. Resetting to defaults.");
                        return [...STARTER_FACTS];
                    }
                } catch (error) {
                    console.error("Error parsing stored facts:", error, "Resetting to defaults.");
                    return [...STARTER_FACTS];
                }
            }
            return [...STARTER_FACTS];
        }

        function saveFactsToStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(collectedResponses));
            } catch (error) {
                 console.error("Error saving facts to localStorage:", error);
            }
        }

        function clearStoredFacts() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
        }


        // --- Initial Setup ---
        window.onload = function() {
            collectedResponses = loadFactsFromStorage();
            saveFactsToStorage(); // Ensure defaults are saved on first run
            populateFactWall();
            updateScoreDisplay();
            updateBuildResourcesDisplay();
            showSection('intro');
        };

        // --- Core Functions ---

        function populateFactWall() {
            factWall.innerHTML = '';
            // Display in reverse order of storage (newest first)
            collectedResponses.forEach(fact => addFactToWall(fact.text, fact.name, fact.isFact));
        }


        function showSection(sectionId) {
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            const element = document.getElementById(sectionId);
            if (element) {
                element.classList.add('active');
            } else {
                console.error("Section not found:", sectionId);
                return;
            }

            const sections = ['intro', 'concept', 'feasibility', 'importance', 'build', 'conclusion'];
            const currentIndex = sections.indexOf(sectionId);
            const progressPercent = (currentIndex / (sections.length - 1)) * 100;
            progressBar.style.width = progressPercent + '%';

            updateCosmicVisuals(sectionId);

            if (sectionId === 'build') {
                updateBuildResourcesDisplay();
                updateBuildButtons();
            }
             if (sectionId === 'conclusion') {
                 finalizeResults();
             }
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = score;
            scoreDisplay.classList.add('resource-animation');
            setTimeout(() => scoreDisplay.classList.remove('resource-animation'), 500);
        }

        function updateBuildResourcesDisplay() {
            resourcesBuildDisplay.textContent = currentResources;
            resourcesBuildCounter.textContent = currentResources;
            resourcesBuildDisplay.classList.add('resource-animation');
            setTimeout(() => resourcesBuildDisplay.classList.remove('resource-animation'), 500);
        }

         function updateEnergyCollectedDisplay() {
            let calculatedEnergy = Math.min(100,
                (buildAllocations.satellites * 3) +
                (buildAllocations.energy * 5) +
                (buildAllocations.transmission * 2) +
                (buildAllocations.stability * 1)
            );
            energyCollected = Math.round(calculatedEnergy);
            energyCollectedDisplay.textContent = energyCollected + '%';
        }


        function selectOption(element, questionId, isCorrect) {
            if (sectionState[questionId].answered) return;
            sectionState[questionId].answered = true;

            const feedbackElement = document.getElementById(`${questionId}-feedback`);
            const optionsContainer = document.getElementById(`${questionId}-options`);
            const responseForm = document.getElementById(`${questionId}-response`);
            const nextButton = document.getElementById(`${questionId}-next`);

            optionsContainer.querySelectorAll('.option').forEach(opt => {
                opt.onclick = null;
                opt.classList.add('disabled');
                if (opt !== element) opt.style.opacity = '0.6';
            });

            element.classList.add('selected');

            if (isCorrect) {
                score += 10;
                element.classList.add('correct');
                feedbackElement.innerHTML = `<p><strong>Correct!</strong> ${getFeedbackText(questionId, true)}</p>`;
                feedbackElement.className = 'feedback correct';
            } else {
                score += 2;
                element.classList.add('incorrect');
                feedbackElement.innerHTML = `<p><strong>Not quite!</strong> ${getFeedbackText(questionId, false)}</p>`;
                feedbackElement.className = 'feedback incorrect';
                optionsContainer.querySelectorAll('.option').forEach(opt => {
                    const onclickAttr = opt.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(', true)')) {
                         opt.classList.add('correct');
                         opt.style.opacity = '1';
                    }
                 });
            }

            updateScoreDisplay();
            responseForm.style.display = 'block';
            nextButton.style.display = 'inline-block';
        }

        function getFeedbackText(questionId, isCorrect) {
            switch (questionId) {
                case 'concept': return isCorrect ? "Dyson proposed a 'swarm' of collectors. A solid shell is likely unstable!" : "While sci-fi loves solid shells, Dyson proposed a 'swarm' of many collectors. A solid shell would face huge gravitational stress!";
                case 'feasibility': return isCorrect ? "Exactly! The sheer amount of material needed is staggering - maybe needing entire planets!" : "While other factors are tricky, getting enough *stuff* (materials) is the biggest hurdle. We might need to dismantle planets!";
                case 'importance': return isCorrect ? "Right! It represents the ultimate energy goal for advanced civilizations and could be a sign of alien life (technosignature)." : "The main idea is capturing nearly ALL a star's energy. It's also a potential 'technosignature' – a sign of advanced alien tech.";
                default: return "";
            }
        }

        function submitResponse(sectionId) {
            if (sectionId !== 'build' && sectionState[sectionId].submitted) return;

            const thoughtInput = document.getElementById(`${sectionId}-thought`);
            const isNotFactCheckbox = document.getElementById(`${sectionId}-fact-check`);
            const thoughtText = thoughtInput.value.trim();
            const isNotFact = isNotFactCheckbox.checked;

            if (thoughtText) {
                const currentName = nameInput.value.trim() || userName;
                const newEntry = { text: thoughtText, name: currentName, isFact: !isNotFact };

                collectedResponses.unshift(newEntry); // Add to start of array
                addFactToWall(newEntry.text, newEntry.name, newEntry.isFact); // Add visually
                saveFactsToStorage(); // Save updated array

                thoughtInput.value = '';
                isNotFactCheckbox.checked = false;
                sectionState[sectionId].submitted = true;

                const submitButton = thoughtInput.closest('.form-group').querySelector('.btn-submit');
                 if (submitButton) {
                    const originalText = submitButton.textContent;
                    submitButton.textContent = 'Added!';
                    submitButton.disabled = (sectionId !== 'build');
                    setTimeout(() => { submitButton.textContent = originalText; }, 1500);
                 }
                 score += 5;
                 updateScoreDisplay();
            } else {
                alert("Please share a thought or fact first!");
            }
        }

        function addFactToWall(text, name, isFact) {
            const li = document.createElement('li');
            li.innerHTML = `${text} <span class="fact-attribution">- ${name} ${isFact ? '(Fact)' : '(Thought/Idea)'}</span>`;
             if (!isFact) li.classList.add('not-fact');
            factWall.insertBefore(li, factWall.firstChild); // Prepend
        }

        function allocateResources(type, cost) {
            if (currentResources >= cost) {
                currentResources -= cost;
                buildAllocations[type]++;
                updateBuildResourcesDisplay();
                updateEnergyCollectedDisplay();
                updateBuildButtons();
                addPanelToVisual();
                score += Math.round(cost / 5);
                updateScoreDisplay();
            } else {
                alert("Not enough Curiosity Points!");
            }
        }

         function updateBuildButtons() {
            document.querySelectorAll('.build-btn').forEach(button => {
                const costText = button.textContent.match(/-(\d+)/);
                if (costText && costText[1]) {
                    const cost = parseInt(costText[1]);
                    button.disabled = currentResources < cost;
                } else {
                    button.disabled = false;
                }
            });
        }

        function submitFinalThought() {
             if (sectionState.final.submitted) return;

             const finalThoughtText = finalThoughtInput.value.trim();
             const isNotFactCheckbox = document.getElementById('final-fact-check');
             const isNotFact = isNotFactCheckbox.checked;
             const finalName = nameInput.value.trim();

             if (!finalName) {
                 alert("Please enter your name!");
                 return;
             }
             userName = finalName;
             displayName.textContent = userName;

             if (finalThoughtText) {
                 const newEntry = { text: finalThoughtText, name: userName, isFact: !isNotFact };
                 collectedResponses.unshift(newEntry);
                 addFactToWall(newEntry.text, newEntry.name, newEntry.isFact);
                 saveFactsToStorage(); // Save updated array
                 finalThoughtInput.value = '';
                 isNotFactCheckbox.checked = false;
             }

             sectionState.final.submitted = true;
             const submitButton = finalThoughtInput.closest('.form-group').querySelector('.btn-submit');
             if (submitButton) {
                 submitButton.textContent = "Submitted!";
                 submitButton.disabled = true;
             }
             startConfetti();
        }

        function finalizeResults() {
            finalScoreDisplay.textContent = score;
            finalEnergyDisplay.textContent = energyCollected + '%';
            displayName.textContent = nameInput.value.trim() || userName;
            populateFactWall(); // Ensure wall is up-to-date
        }


        function restartGame() {
            clearStoredFacts(); // Clear localStorage
            score = 0;
            currentResources = 100;
            energyCollected = 0;
            userName = "Explorer";
            buildAllocations = { satellites: 0, energy: 0, transmission: 0, stability: 0 };
            collectedResponses = [...STARTER_FACTS]; // Reset to starter facts
            saveFactsToStorage(); // Save the reset state

            sectionState = { // Reset section states
                 'concept': { answered: false, submitted: false },
                 'feasibility': { answered: false, submitted: false },
                 'importance': { answered: false, submitted: false },
                 'build': { submitted: false },
                 'final': { submitted: false }
            };

            // Reset UI elements
            updateScoreDisplay();
            updateBuildResourcesDisplay();
            updateEnergyCollectedDisplay();
            nameInput.value = '';
            finalThoughtInput.value = '';
            displayName.textContent = userName;
            document.getElementById('final-fact-check').checked = false;
            document.getElementById('build-thought').value = '';
            document.getElementById('build-fact-check').checked = false;

            // Reset question sections UI
            ['concept', 'feasibility', 'importance'].forEach(id => {
                document.getElementById(`${id}-feedback`).style.display = 'none';
                document.getElementById(`${id}-feedback`).innerHTML = '';
                document.getElementById(`${id}-response`).style.display = 'none';
                document.getElementById(`${id}-next`).style.display = 'none';
                document.getElementById(`${id}-thought`).value = '';
                document.getElementById(`${id}-fact-check`).checked = false;

                const optionsContainer = document.getElementById(`${id}-options`);
                optionsContainer.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                    opt.style.opacity = '1';
                     const args = opt.getAttribute('onclick')?.match(/'([^']*)',\s*(true|false)/);
                     if (args) { opt.onclick = () => selectOption(opt, args[1], args[2] === 'true'); }
                });
                 const submitBtn = document.getElementById(`${id}-response`).querySelector('.btn-submit');
                 if (submitBtn) { submitBtn.textContent = 'Add to Collection'; submitBtn.disabled = false; }
            });

             // Reset build section UI
             updateBuildButtons();
             clearCosmicVisuals('buildContainer');
             const buildSubmitBtn = document.getElementById('build-response').querySelector('.btn-submit');
             if (buildSubmitBtn) { buildSubmitBtn.textContent = 'Add to Wall of Facts'; buildSubmitBtn.disabled = false; }

             // Reset final section UI
             const finalSubmitBtn = document.getElementById('conclusion').querySelector('.btn-submit');
             if (finalSubmitBtn) { finalSubmitBtn.textContent = 'Submit & Celebrate!'; finalSubmitBtn.disabled = false; }

            // Refresh Wall and Start Over
            populateFactWall();
            stopConfetti();
            showSection('intro');
        }

        // --- NEW Mailto Function ---
        function generateMailtoLink() {
            // !!! IMPORTANT: Replace this with the actual recipient email address !!!
            const recipientEmail = "YOUR_EMAIL_ADDRESS_HERE@example.com";

            // --- Gather data ---
            const finalName = nameInput.value.trim() || userName; // Use entered name or default
            const finalScore = score;
            const finalEnergy = energyCollected;
            // Retrieve the latest responses from localStorage (or the current array)
            const currentResponses = loadFactsFromStorage(); // Load fresh data

            // --- Format email body ---
            let emailBody = `Cosmic Curiosity Results for Mary!\n`;
            emailBody += `Submitted by: ${finalName}\n\n`;
            emailBody += `Final Fun Points: ${finalScore}\n`;
            emailBody += `Energy Collection: ${finalEnergy}%\n\n`;
            emailBody += `--- Wall of Facts & Curiosities ---\n\n`;

            if (currentResponses.length > 0) {
                // Iterate in reverse to show oldest first in email (opposite of wall)
                for (let i = currentResponses.length - 1; i >= 0; i--) {
                    const entry = currentResponses[i];
                    emailBody += `"${entry.text}" - ${entry.name} (${entry.isFact ? 'Fact' : 'Thought/Idea'})\n\n`;
                }
            } else {
                emailBody += "(No facts or thoughts were submitted)\n";
            }

            // --- Format subject ---
            const emailSubject = `Cosmic Curiosity Results from ${finalName}`;

            // --- Encode components for URL ---
            const encodedSubject = encodeURIComponent(emailSubject);
            const encodedBody = encodeURIComponent(emailBody);

            // --- Construct mailto link ---
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodedSubject}&body=${encodedBody}`;

            // --- Check length (optional but recommended) ---
            const MAX_MAILTO_LENGTH = 2000; // A common approximate limit
            if (mailtoLink.length > MAX_MAILTO_LENGTH) {
                alert("Warning: The collected results are very long and might exceed email link limits. The email draft might be incomplete or fail to open.");
            }

            // --- Open email client ---
            // This attempts to open the user's default email client
            window.location.href = mailtoLink;
        }


        // --- Visual Effect Functions ---
        function updateCosmicVisuals(sectionId) {
            ['conceptContainer', 'feasibilityContainer', 'importanceContainer', 'buildContainer'].forEach(clearCosmicVisuals);
            const container = document.getElementById(`${sectionId}Container`);
            if (!container) return;
            if (sectionId === 'concept') { /* Basic star */ }
            else if (sectionId === 'feasibility') addCosmicRing(container);
            else if (sectionId === 'importance') { addCosmicRing(container); addMorePanels(container, 5); }
            else if (sectionId === 'build') completeDysonSwarmVisual(container);
        }
        function clearCosmicVisuals(containerId) {
             const container = document.getElementById(containerId);
             if (container) {
                 const elementsToRemove = container.querySelectorAll('.cosmic-ring, .cosmic-panel');
                 elementsToRemove.forEach(el => el.remove());
             }
        }
        function addCosmicRing(targetContainer = document.getElementById('feasibilityContainer')) {
             if (!targetContainer) return;
             clearCosmicVisuals(targetContainer.id);
             const ring = document.createElement('div');
             ring.className = 'cosmic-ring';
             targetContainer.appendChild(ring);
             void ring.offsetWidth; // Trigger reflow
             ring.style.opacity = '1';
        }
        function addMorePanels(targetContainer = document.getElementById('importanceContainer'), count = 5) {
             if (!targetContainer) return;
             if (!targetContainer.querySelector('.cosmic-ring')) addCosmicRing(targetContainer);
             const radius = 100;
             for (let i = 0; i < count; i++) {
                 const angle = (i / count) * 2 * Math.PI;
                 const x = radius * Math.cos(angle);
                 const y = radius * Math.sin(angle);
                 const panel = document.createElement('div');
                 panel.className = 'cosmic-panel';
                 panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad)`;
                 targetContainer.appendChild(panel);
                 void panel.offsetWidth; // Trigger reflow
                 panel.style.opacity = '0.7';
             }
        }
         function addPanelToVisual() {
             const container = document.getElementById('buildContainer');
             if (!container) return;
             const panelCount = container.querySelectorAll('.cosmic-panel').length;
             if (panelCount >= MAX_PANELS) return;
             const radius = 100;
             const angle = (panelCount / MAX_PANELS) * 2 * Math.PI + Math.random() * 0.5 - 0.25;
             const x = radius * Math.cos(angle);
             const y = radius * Math.sin(angle);
             const panel = document.createElement('div');
             panel.className = 'cosmic-panel';
             panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(0.1)`;
             panel.style.opacity = '0';
             container.appendChild(panel);
             setTimeout(() => {
                 panel.style.opacity = '0.8';
                 panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(1)`;
             }, 50);
         }
        function completeDysonSwarmVisual(targetContainer = document.getElementById('buildContainer')) {
            if (!targetContainer) return;
            clearCosmicVisuals(targetContainer.id);
            addCosmicRing(targetContainer);
            const totalAllocations = Object.values(buildAllocations).reduce((sum, val) => sum + val, 0);
            const numPanels = Math.min(MAX_PANELS, Math.ceil(totalAllocations / 2));
            addMorePanels(targetContainer, numPanels);
        }
        // --- Confetti Functions ---
        let confettiInterval = null;
        function startConfetti() { stopConfetti(); createConfettiPiece(); confettiInterval = setInterval(createConfettiPiece, 100); setTimeout(stopConfetti, 5000); }
        function stopConfetti() { clearInterval(confettiInterval); confettiInterval = null; setTimeout(() => { confettiContainer.innerHTML = ''; }, 3000); }
        function createConfettiPiece() { if (!confettiContainer) return; const confetti = document.createElement('div'); const randomClass = `c${Math.floor(Math.random() * 5)}`; confetti.className = `confetti ${randomClass}`; confetti.style.left = `${Math.random() * 100}vw`; confetti.style.animationDelay = `${Math.random() * 2}s`; confetti.style.transform = `rotate(${Math.random() * 360}deg)`; confettiContainer.appendChild(confetti); setTimeout(() => { confetti.remove(); }, 5000); }

    </script>
</body>
</html>



