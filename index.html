<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Curiosity Explorer: For Mary's Science Fair Birthday!</title>
    <style>
        /* Basic variables and styles */
        :root {
            --primary: #6d28d9; /* Deep Purple */
            --secondary: #ec4899; /* Bright Pink */
            --accent: #f59e0b; /* Amber */
            --light: #fdf2f8; /* Very Light Pink */
            --dark: #1e1b4b; /* Dark Indigo */
            --success: #10b981; /* Emerald Green */
            --info: #3b82f6; /* Blue */
            --white: #ffffff;
            --error: #ef4444; /* Red */
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; /* Fun, kid-friendly font */
            line-height: 1.6;
            color: var(--dark);
            background-color: var(--light);
            background-image: linear-gradient(120deg, #fdf2f8 0%, #e0f2fe 100%); /* Light gradient background */
            margin: 0;
            padding: 1rem; /* Added padding for smaller screens */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Main content container */
        .container {
            width: 90%;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border: 3px dashed var(--secondary); /* Dashed pink border */
        }

        /* Headings */
        h1, h2, h3 {
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }

        h1 {
            margin-bottom: 1.5rem;
            font-size: 2.2rem; /* Slightly smaller for better fit */
            background: linear-gradient(120deg, var(--primary), var(--secondary)); /* Gradient text */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* Use transparent text color to show gradient */
            -webkit-text-fill-color: transparent; /* For Safari */
        }

        h2 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.6rem; /* Slightly smaller */
            color: var(--secondary);
        }

        h3 {
             font-size: 1.3rem;
             margin-bottom: 0.8rem; /* Added margin bottom */
        }

        /* Paragraphs */
        p {
            margin-bottom: 1rem;
            font-size: 1rem; /* Slightly smaller for conciseness */
        }

        /* Birthday Banner */
        .birthday-banner {
            text-align: center;
            padding: 0.8rem; /* Reduced padding */
            background-color: rgba(236, 72, 153, 0.1); /* Light pink background */
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .birthday-banner p {
            font-size: 1.1rem; /* Slightly smaller */
            font-weight: bold;
            color: var(--secondary);
            margin: 0;
        }

        /* Game Sections */
        .game-section {
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Smooth transition */
        }

        .game-section.active {
            display: block; /* Show active section */
            opacity: 1;
            transform: translateY(0);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.7rem 1.4rem; /* Slightly smaller padding */
            margin: 0.5rem 0.25rem;
            border-radius: 50px; /* Rounded pill shape */
            font-size: 0.95rem; /* Slightly smaller font */
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit; /* Use body font */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary);
            transform: translateY(-3px) scale(1.05); /* Lift and scale effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background-color: #cccccc; /* Grey out disabled buttons */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7; /* Make disabled buttons slightly transparent */
        }

        .btn-next { background-color: var(--accent); float: right; }
        .btn-prev { background-color: var(--info); float: left; }
        .btn-submit { background-color: var(--success); display: block; margin: 1rem auto; }
        .btn-restart { background-color: var(--primary); display: block; margin: 1rem auto; } /* Style retained but button removed */
        .btn-email { background-color: var(--info); display: block; margin: 1rem auto; } /* Style retained but button removed */


        /* Options for multiple choice */
        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Better spacing */
            margin: 1.5rem 0;
        }

        .option {
            flex-basis: calc(50% - 1rem); /* Two columns with gap */
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: rgba(59, 130, 246, 0.1); /* Light blue background */
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Include padding and border in width */
        }

        .option:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: var(--info);
            transform: translateY(-3px);
        }

        .option.selected { background-color: rgba(236, 72, 153, 0.2); border-color: var(--secondary); }
        .option.correct { background-color: rgba(16, 185, 129, 0.2); border-color: var(--success); cursor: default; }
        .option.incorrect { background-color: rgba(245, 158, 11, 0.2); border-color: var(--accent); cursor: default; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; } /* Style for disabled options after answering */

        /* Feedback messages */
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 15px;
            display: none; /* Hidden by default */
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
            font-size: 0.9em; /* Slightly smaller feedback text */
        }

        .feedback.correct { background-color: rgba(16, 185, 129, 0.1); border-left-color: var(--success); display: block; }
        .feedback.incorrect { background-color: rgba(245, 158, 11, 0.1); border-left-color: var(--accent); display: block; }
        .feedback.saving { background-color: rgba(59, 130, 246, 0.1); border-left-color: var(--info); display: block; }
        .feedback.save-success { background-color: rgba(16, 185, 129, 0.1); border-left-color: var(--success); display: block; }
        .feedback.save-error { background-color: rgba(239, 68, 68, 0.1); border-left-color: var(--error); display: block; }


        /* Score Display */
        .score-display {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* Cosmic Sphere Visualization */
        .cosmic-sphere-container {
            position: relative;
            width: 250px; /* Smaller size */
            height: 250px;
            margin: 1.5rem auto; /* Reduced margin */
            perspective: 1000px; /* For 3D effects if needed */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .star {
            position: absolute;
            width: 80px; /* Smaller star */
            height: 80px;
            background: radial-gradient(circle, #FFDA63, #FF9800); /* Brighter yellow gradient */
            border-radius: 50%;
            box-shadow: 0 0 25px 8px rgba(255, 193, 7, 0.6); /* Adjusted shadow */
            z-index: 1; /* Star is behind elements */
        }

        .cosmic-ring {
            position: absolute;
            border: 4px dashed rgba(236, 72, 153, 0.7); /* Dashed ring */
            border-radius: 50%;
            width: 150px; /* Ring size */
            height: 150px;
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.5);
            animation: rotate 20s linear infinite;
            z-index: 2; /* Ring above star */
            opacity: 0; /* Initially hidden */
            transition: opacity 0.5s ease-in-out;
        }

        .cosmic-panel {
            position: absolute;
            width: 20px;
            height: 30px;
            background-color: rgba(109, 40, 217, 0.6); /* Semi-transparent purple */
            border: 1px solid rgba(109, 40, 217, 0.9);
            border-radius: 4px;
            transform-origin: center;
            box-shadow: 0 0 5px rgba(109, 40, 217, 0.5);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0; /* Initially hidden */
            z-index: 3; /* Panels above ring */
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: rgba(59, 130, 246, 0.2);
            border-radius: 50px;
            margin-bottom: 1rem;
            overflow: hidden;
            height: 15px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        /* Clearfix for floated elements */
        .clearfix::after { content: ""; clear: both; display: table; }

        /* Resource Counter */
        .resource-counter {
            font-size: 1rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        .resource-animation { animation: pulse 0.5s ease-in-out; }

        /* Wall of Facts / Contributions / Wishes */
        .contributions-wall { /* Renamed for clarity */
            background-color: rgba(16, 185, 129, 0.1); /* Light green background */
            border-radius: 15px;
            padding: 1rem;
            margin: 1.5rem 0;
            max-height: 300px;
            min-height: 100px; /* Ensure some height even when loading */
            overflow-y: auto; /* Scroll if content overflows */
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .contributions-wall h3 {
            color: var(--success);
            text-align: center;
            border-bottom: 2px dashed var(--success);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        .contributions-wall ul { list-style-type: none; padding: 0; }

        .contributions-wall li {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background-color: var(--white);
            border-radius: 10px;
            border-left: 3px solid var(--success);
            font-size: 0.9rem; /* Slightly smaller text */
            word-wrap: break-word; /* Prevent long text overflow */
        }
        .contributions-wall li.not-fact {
            border-left-color: var(--info); /* Different color for non-facts */
        }
        .contributions-wall li.wish {
            border-left-color: var(--secondary); /* Different color for wishes */
        }

        .fact-attribution {
            font-style: italic;
            font-size: 0.75rem; /* Smaller attribution */
            color: var(--primary);
            margin-top: 0.3rem;
            display: block; /* Ensure it's on its own line */
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--primary);
            font-size: 0.95rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.7rem; /* Slightly smaller padding */
            border-radius: 10px;
            border: 2px solid rgba(109, 40, 217, 0.3);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Include padding in width */
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea { min-height: 80px; resize: vertical; }

        .input-hint {
            font-size: 0.75rem; /* Smaller hint text */
            color: var(--secondary);
            margin-top: 0.3rem;
        }

        /* Congratulations Container */
        .congrats-container { text-align: center; margin: 2rem 0; }

        /* Confetti Animation */
        .confetti-container {
            position: fixed; /* Cover the whole screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks through */
            overflow: hidden;
            z-index: 1000; /* Above everything */
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: var(--secondary);
            opacity: 0.7;
            animation: confetti-fall 3s linear infinite;
        }
        .confetti.c1 { background-color: var(--primary); animation-duration: 3.5s; }
        .confetti.c2 { background-color: var(--accent); animation-duration: 2.5s; }
        .confetti.c3 { background-color: var(--success); animation-duration: 4s; }
        .confetti.c4 { background-color: var(--info); animation-duration: 3.2s; }


        /* Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 16px; /* Slightly smaller */
            height: 16px;
            accent-color: var(--primary); /* Style the checkmark color */
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 0.85rem; /* Smaller label */
            color: var(--primary);
            margin-bottom: 0; /* Override default label margin */
            font-weight: normal; /* Normal weight */
            cursor: pointer;
        }

        /* Sparkle Effect */
        .sparkle { display: inline-block; animation: sparkle 1.5s infinite ease-in-out; }

        /* Mary Says Quote Box */
        .mary-says {
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 15px 15px 0;
            font-style: italic;
            font-size: 0.9rem;
        }

        /* Fun Facts List */
        .fun-facts-list {
            list-style-type: '‚ú®'; /* Use sparkle emoji as bullet */
            padding-left: 2rem;
            margin: 1.5rem 0;
        }
        .fun-facts-list li {
            margin-bottom: 0.8rem;
            padding-left: 0.5rem;
            font-size: 0.95rem;
        }

        /* Styles for the Revamped Build Section */
        .build-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; /* Space out buttons */
            margin: 1.5rem 0;
        }

        .build-choices .btn.build-btn {
            flex-basis: calc(50% - 1rem); /* Two columns layout */
            margin-bottom: 1rem;
            padding: 1rem; /* More padding for description */
            height: auto; /* Allow button height to adjust */
            text-align: left; /* Align text left */
            display: flex; /* Use flexbox for content alignment */
            flex-direction: column; /* Stack title and description */
            box-shadow: 0 3px 5px rgba(0,0,0, 0.1); /* Softer shadow */
            background-color: var(--info); /* Use info color */
            line-height: 1.4; /* Better spacing for text */
            border-radius: 15px; /* Less rounded than pill */
        }

        .build-choices .btn.build-btn:hover {
            background-color: var(--primary); /* Use primary on hover */
             transform: translateY(-2px) scale(1.02); /* Subtle hover effect */
        }

         .build-choices .btn.build-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
         }


        .build-choices .btn.build-btn strong {
            display: block;
            margin-bottom: 0.5rem; /* Space between title and desc */
            font-size: 1rem; /* Slightly larger title */
            color: var(--white); /* Ensure title is white */
        }

        .choice-desc {
            font-size: 0.85rem; /* Smaller description text */
            color: rgba(255, 255, 255, 0.9); /* Lighter text for description */
        }

        .build-feedback {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            background-color: rgba(236, 72, 153, 0.1); /* Light pink background */
            border-left: 4px solid var(--secondary); /* Pink border */
            min-height: 50px; /* Ensure space even when empty */
            transition: background-color 0.3s ease;
            font-size: 0.95rem;
        }
        .build-feedback.success {
             background-color: rgba(16, 185, 129, 0.1); /* Light green for success */
             border-left-color: var(--success);
        }
        .build-feedback.info {
             background-color: rgba(59, 130, 246, 0.1); /* Light blue for info */
             border-left-color: var(--info);
        }


        .build-results {
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: rgba(109, 40, 217, 0.05); /* Very light purple */
            border-radius: 8px;
            text-align: center;
        }
        .build-results p {
            margin: 0.3rem 0;
        }
        .build-results strong {
             color: var(--primary);
        }

        /* Keyframe Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); } /* Smaller pulse */
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; } /* Adjusted sparkle */
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container { padding: 1rem; width: 95%; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            p { font-size: 0.95rem; }
            .option { flex-basis: 100%; } /* Stack options vertically */
            .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
            .cosmic-sphere-container { width: 200px; height: 200px; }
            .star { width: 60px; height: 60px; }
            .cosmic-ring { width: 120px; height: 120px; }
            .fun-facts-list { padding-left: 1.5rem; }
             /* Responsive adjustments for build section */
            .build-choices .btn.build-btn {
                 flex-basis: 100%; /* Stack buttons vertically on small screens */
            }
        }

    </style>
</head>
<body>
    <div class="confetti-container" id="confettiContainer"></div>

    <div class="container">
        <div class="birthday-banner">
            <p><span class="sparkle">‚ú®</span> For Mary's Birthday Science Fair! <span class="sparkle">‚ú®</span></p>
        </div>

        <h1>Cosmic Curiosity Explorer</h1>
        <p class="score-display">Fun Points: <span id="score">0</span></p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="game-section active" id="intro">
            <h2>Welcome, Science Fair Explorer!</h2>
            <p>You've found an exhibit on the <strong>Dyson Sphere</strong> - a giant structure around a star to capture its energy!</p>
            <div class="mary-says">
                "This is the year my dreams will come true (why not?)" - Mary
            </div>
            <p>In this adventure, you'll:</p>
            <ul>
                <li>Learn about this huge cosmic idea.</li>
                <li>See some fun facts.</li>
                <li>Share your thoughts and questions.</li>
                <li>See what others wondered.</li>
                <li>Leave a birthday wish for Mary!</li>
            </ul>
            <p class="resource-counter">Curiosity Points: <span id="resources-intro">100</span></p> <div class="clearfix">
                <button class="btn btn-next" onclick="showSection('fun-facts')">See Fun Facts! ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="fun-facts">
            <h2><span class="sparkle">‚ú®</span> Dyson Sphere Fun Facts! <span class="sparkle">‚ú®</span></h2>
            <p>Get ready for some mind-blowing ideas!</p>
            <ul class="fun-facts-list" id="fun-facts-list">
                </ul>
             <div class="mary-says">
                Astronomers actually look for Dyson Spheres around other stars as potential signs of advanced extraterrestrial civilizations!
            </div>
            <div class="clearfix">
                 <button class="btn btn-prev" onclick="showSection('intro')">‚Üê Back</button>
                <button class="btn btn-next" onclick="showSection('concept')">What IS It? ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="concept">
            <h2>What's a Dyson Sphere?</h2>
            <div class="cosmic-sphere-container" id="conceptContainer">
                <div class="star"></div>
            </div>
            <p>In 1960, Freeman Dyson imagined advanced civilizations building huge structures around stars to catch ALL their energy.</p>
            <p>What form did Dyson suggest this might take?</p>
            <div class="options" id="concept-options">
                <div class="option" onclick="selectOption(this, 'concept', false)">A solid shell around a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', true)">A swarm of collectors orbiting a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A giant space vacuum for star energy.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A magic sphere to make stars last forever.</div>
            </div>
            <div class="feedback" id="concept-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('fun-facts')">‚Üê Back</button>
                <button class="btn btn-next" id="concept-next" style="display: none;" onclick="showSection('feasibility'); addCosmicRing();">Explore Feasibility ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="feasibility">
            <h2>Could We Build One?</h2>
             <div class="cosmic-sphere-container" id="feasibilityContainer">
                <div class="star"></div>
                 </div>
            <p>What's the biggest challenge in building a Dyson Swarm?</p>
            <div class="options" id="feasibility-options">
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting the star's permission.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Inventing super-efficient solar panels.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', true)">Getting enough building materials.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting all countries to agree.</div>
            </div>
            <div class="feedback" id="feasibility-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('concept')">‚Üê Back</button>
                <button class="btn btn-next" id="feasibility-next" style="display: none;" onclick="showSection('importance'); addMorePanels();">Why Bother? ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="importance">
            <h2>Why Is It Important?</h2>
             <div class="cosmic-sphere-container" id="importanceContainer">
                <div class="star"></div>
                 </div>
            <p>Even if hard to build, why is the Dyson Sphere concept useful?</p>
            <div class="options" id="importance-options">
                <div class="option" onclick="selectOption(this, 'importance', false)">It's a great space umbrella.</div>
                <div class="option" onclick="selectOption(this, 'importance', true)">It represents ultimate energy capture.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It's mainly for sci-fi stories.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It helps send messages to aliens.</div>
            </div>
            <div class="feedback" id="importance-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('feasibility')">‚Üê Back</button>
                <button class="btn btn-next" id="importance-next" style="display: none;" onclick="showSection('build'); completeDysonSwarmVisual();">Build Your Own! ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="build">
            <h2>Mission Control: Dyson Swarm Design</h2>
            <p>Let's design our Dyson Swarm blueprint! You have <strong id="resources-build-display">100</strong> Design Points to allocate.</p>
            <p>Choose mission phases to add components and improve efficiency. Each phase adds a crucial part to our plan!</p>

            <div class="cosmic-sphere-container" id="buildContainer">
                <div class="star"></div>
                 </div>

            <div class="build-choices">
                <button class="btn build-btn" id="btn-phase1" onclick="runMissionPhase('phase1', 25)">
                    <strong>Phase 1: Deploy Collectors (-25 Pts)</strong>
                    <span class="choice-desc">Launch basic solar collectors into orbit. Starts gathering energy.</span>
                </button>
                <button class="btn build-btn" id="btn-phase2" onclick="runMissionPhase('phase2', 30)">
                    <strong>Phase 2: Add Power Converters (-30 Pts)</strong>
                    <span class="choice-desc">Install systems to convert raw sunlight into usable power. Boosts efficiency significantly.</span>
                </button>
                <button class="btn build-btn" id="btn-phase3" onclick="runMissionPhase('phase3', 20)">
                    <strong>Phase 3: Build Relay Stations (-20 Pts)</strong>
                    <span class="choice-desc">Construct stations to beam collected energy back home (or wherever it's needed!). Improves delivery.</span>
                </button>
                <button class="btn build-btn" id="btn-phase4" onclick="runMissionPhase('phase4', 25)">
                    <strong>Phase 4: Implement Stabilizers (-25 Pts)</strong>
                    <span class="choice-desc">Add systems to keep the swarm stable and prevent collisions. Increases reliability.</span>
                </button>
            </div>

            <div class="build-feedback" id="build-feedback">
                <p>Awaiting your command, Commander!</p>
            </div>

            <div class="build-results">
                <p>Blueprint Efficiency: <strong id="energy-collected">0</strong>%</p>
                <p class="resource-counter">Design Points Left: <strong id="resources-build">100</strong></p>
            </div>

            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('importance')">‚Üê Back</button>
                <button class="btn btn-next" id="build-next" onclick="showSection('share-thoughts')">Share Your Thoughts ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="share-thoughts">
             <h2>Share Your Cosmic Curiosities!</h2>
             <p>Got a cool fact, a burning question, or a wild idea about Dyson Spheres or space energy?</p>
             <p>Add it here for Mary's collection!</p>
             <div class="form-group">
                 <label for="shared-thought">Your Fact, Thought, or Question:</label>
                 <textarea id="shared-thought" placeholder="e.g., A cool fact is... / I wonder about... / What if...?"></textarea>
                 <div class="checkbox-container">
                     <input type="checkbox" id="shared-fact-check">
                     <label for="shared-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                 </div>
                 <button class="btn btn-submit" id="submit-thought-button" onclick="submitThought()">Add to Collection</button>
             </div>
              <div class="mary-says">
                 Dyson spheres captivate our imagination as megastructures that could harness the entire energy output of a star,
                 representing an engineering feat so advanced it borders on magic while demonstrating how truly vast our technological potential might be.
                 This concept naturally leads us to wonder what other cosmic engineering marvels might be possible and what advanced civilizations across the universe
                 might have already achieved.
              </div>
             <div class="clearfix">
                 <button class="btn btn-prev" onclick="showSection('build')">‚Üê Back</button>
                 <button class="btn btn-next" onclick="showSection('collected-questions');">See Collected Questions ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="collected-questions">
             <h2>Collected Questions & Ideas</h2>
             <p>Here's what other explorers (and maybe you!) have wondered:</p>
             <div class="contributions-wall">
                 <h3>Cosmic Question Corner</h3>
                 <ul id="collected-questions-list">
                     <li>Loading questions...</li>
                     </ul>
             </div>
             <div class="clearfix">
                  <button class="btn btn-prev" onclick="showSection('share-thoughts')">‚Üê Back</button>
                  <button class="btn btn-next" onclick="showSection('collected-wishes');">See Birthday Wishes ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="collected-wishes">
             <h2>Birthday Wishes for Mary!</h2>
             <p>Let's celebrate Mary's birthday with these awesome messages:</p>
             <div class="contributions-wall">
                 <h3>Happy Birthday Wall!</h3>
                 <ul id="collected-wishes-list">
                     <li>Loading wishes...</li>
                    </ul>
             </div>
              <div class="mary-says">
                 "Thank you all for the wonderful wishes!" - Mary (probably!)
              </div>
             <div class="clearfix">
                  <button class="btn btn-prev" onclick="showSection('collected-questions')">‚Üê Back</button>
                  <button class="btn btn-next" onclick="showSection('conclusion');">Final Results & Wish ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="conclusion">
            <div class="congrats-container">
                <h2>Thanks for Exploring, <span id="display-name">Explorer</span>!</h2>
                <p>Final Fun Points: <span id="final-score">0</span></p>
                <p>Your Blueprint Efficiency: <span id="final-energy">0</span>%</p>
            </div>

            <div class="form-group">
                <label for="name-input">Your Name (to sign your wish & save results):</label>
                <input type="text" id="name-input" placeholder="Your Name">

                <label for="birthday-wish">Birthday wishes for Mary?</label>
                <textarea id="birthday-wish" placeholder="e.g., Happy Birthday Mary! Have a stellar day!"></textarea>
                <div class="feedback" id="save-feedback" style="display: none; margin-top: 1rem;"></div>
                <button class="btn btn-submit" id="submit-wish-button" onclick="submitBirthdayWish()">Add Your Wish & Save Results!</button>
            </div>

             <div class="contributions-wall">
                 <h3>Wall of ALL Contributions</h3>
                 <p style="text-align: center; font-size: 0.9em;">Facts, Thoughts & Wishes from Mary's Science Fair:</p>
                 <ul id="fact-wall">
                     <li>Loading contributions...</li>
                    </ul>
             </div>

              <div class="mary-says">
                 "Science fair is an invitation to follow your curiosity. The point is JOY, so only do this if it feels fun!" - Mary
              </div>

             <div class="clearfix">
                 <button class="btn btn-prev" onclick="showSection('collected-wishes')">‚Üê Back</button>
                 </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        // !!! IMPORTANT: REPLACE THIS URL WITH YOUR ACTUAL GOOGLE APPS SCRIPT WEB APP URL !!!
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXohgrElA2ImjfAxK4eUvtgHxZuuoqWuFgCdbmTvBE35pgDA3XwtIeX91PE2iSCvi2/exec';
        // !!! ‡§Æ‡•á‡§ï ‡§∂‡•ç‡§Ø‡•ã‡§∞ ‡§Ø‡•Ç ‡§™‡•á‡§∏‡•ç‡§ü ‡§Ø‡•å‡§∞ ‡§Ø‡•Ç‡§Ü‡§∞‡§è‡§≤ ‡§Ö‡§¨‡•ã‡§µ !!! (Ensuring you paste your URL above!)

        const MAX_PANELS = 12; // Max panels for visualization
        const DYSON_FUN_FACTS = [ // Static data for the fun facts section
            "A Dyson Sphere aims to capture nearly 100% of a star's energy output.",
            "The most likely design isn't a solid shell, but a 'Dyson Swarm' of many orbiting collectors.",
            "Building a Dyson Swarm around our Sun might require dismantling planets like Jupiter for materials!",
            "If aliens built one, it might block visible light but glow brightly in infrared (heat).",
            "The Kardashev Scale ranks civilizations by energy use; Dyson Sphere builders are Type II.",
            "Finding a Dyson Sphere is a key goal in the Search for Extraterrestrial Intelligence (SETI).",
            "Some stars show strange dimming patterns (like Tabby's Star) that *might* hint at megastructures, but natural causes are more likely.",
            "Even a partial Dyson Swarm could provide vastly more energy than Earth currently uses.",
            "The collectors in a swarm would need advanced AI and propulsion to avoid colliding.",
            "Freeman Dyson proposed the idea in a 1960 science paper, inspired by sci-fi!"
        ];
        const STARTER_ENTRIES = [ // Default entries shown initially or if backend fails
            { text: "Our sun makes enough energy in 1 second for humanity's needs for 500,000 years!", name: "Claude", isFact: true, type: 'fact' },
            { text: "Could Dyson Spheres create artificial habitats inside?", name: "Science Friend", isFact: false, type: 'thought' },
            { text: "What if we connected Dyson Spheres around multiple stars?", name: "Cosmic Explorer", isFact: false, type: 'thought' }
        ];

        // --- State Variables ---
        // These variables track the user's progress and choices
        let score = 0; // User's fun points
        let currentResources = 100; // Points for the build section
        let energyCollected = 0; // Efficiency from the build section
        let userName = "Explorer"; // Default user name
        let thoughtDataForSubmission = null; // Temporarily holds the thought data before final submission
        let buildAllocations = { phase1: 0, phase2: 0, phase3: 0, phase4: 0 }; // Tracks build choices
        let sectionState = { // Tracks quiz answers and submission status
            'concept': { answered: false },
            'feasibility': { answered: false },
            'importance': { answered: false },
            'thoughtSubmittedThisSession': false,
            'wishSubmitted': false
        };
        let collectedEntries = []; // Stores entries currently displayed (can include starters)

        // --- DOM Elements (cache them for quicker access) ---
        // Get references to various parts of the HTML page to interact with them
        const scoreDisplay = document.getElementById('score');
        const progressBar = document.getElementById('progressBar');
        const factWall = document.getElementById('fact-wall'); // Final wall
        const collectedQuestionsList = document.getElementById('collected-questions-list'); // Questions wall
        const collectedWishesList = document.getElementById('collected-wishes-list'); // Wishes wall
        const funFactsList = document.getElementById('fun-facts-list'); // Static facts list
        const nameInput = document.getElementById('name-input');
        const birthdayWishInput = document.getElementById('birthday-wish');
        const sharedThoughtInput = document.getElementById('shared-thought');
        const sharedFactCheck = document.getElementById('shared-fact-check');
        const displayName = document.getElementById('display-name');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalEnergyDisplay = document.getElementById('final-energy');
        const resourcesBuildDisplay = document.getElementById('resources-build-display'); // Build points label
        const resourcesBuild = document.getElementById('resources-build'); // Build points counter
        const energyCollectedDisplay = document.getElementById('energy-collected'); // Build efficiency display
        const buildFeedback = document.getElementById('build-feedback'); // Build section messages
        const confettiContainer = document.getElementById('confettiContainer'); // For celebration animation
        const submitThoughtButton = document.getElementById('submit-thought-button');
        const submitWishButton = document.getElementById('submit-wish-button');
        const saveFeedback = document.getElementById('save-feedback'); // Message area on final page

        // --- Initial Setup ---
        // This function runs automatically when the webpage finishes loading
        window.onload = function() {
            collectedEntries = []; // Start with an empty list for dynamic loading
             // Add starter entries so the page isn't blank initially
            STARTER_ENTRIES.forEach(entry => { collectedEntries.push(entry); });

            populateFunFacts(); // Display the built-in fun facts
            // Don't populate dynamic walls on load, wait until sections are shown
            updateScoreDisplay(); // Set initial score display
            updateBuildResourcesDisplay(); // Set initial build points display
            updateEnergyCollectedDisplay(); // Set initial build efficiency display
            showSection('intro'); // Show the first section ('intro')
        };

        // --- Core Functions ---

        /**
         * Populates the fun facts list in the 'fun-facts' section with predefined facts.
         */
        function populateFunFacts() {
            funFactsList.innerHTML = ''; // Clear any previous list items
            DYSON_FUN_FACTS.forEach(fact => { // Loop through each fact
                const li = document.createElement('li'); // Create a new list item element
                li.textContent = fact; // Set its text content
                funFactsList.appendChild(li); // Add it to the list on the page
            });
        }

        /**
         * Adds a single entry (fact, thought, wish) to a specified list element on the page.
         * @param {HTMLElement} listElement - The UL element to add the entry to (e.g., factWall, collectedQuestionsList).
         * @param {object} entry - The entry object { text, name, isFact, type }.
         */
        function addEntryToWall(listElement, entry) {
            if (!listElement) return; // Safety check if the list doesn't exist
            const li = document.createElement('li'); // Create list item
            const textNode = document.createTextNode(entry.text || ''); // Create text for the entry
            const attributionSpan = document.createElement('span'); // Create span for the "- Name (Type)" part
            attributionSpan.className = 'fact-attribution'; // Add CSS class for styling
            attributionSpan.textContent = `- ${entry.name || 'Anonymous'} (${getEntryTypeLabel(entry)})`; // Set attribution text

            li.appendChild(textNode); // Add the main text
            li.appendChild(document.createTextNode(' ')); // Add a space
            li.appendChild(attributionSpan); // Add the attribution

            // Add specific CSS classes for different styling based on type
            if (entry.type === 'wish') { li.classList.add('wish'); }
            else if (entry.type === 'thought' && !entry.isFact) { li.classList.add('not-fact'); } // Style thoughts/ideas differently

            // Add the new item to the *top* of the list (newest first)
            listElement.insertBefore(li, listElement.firstChild);
        }

        /**
         * Gets a user-friendly label for the type of entry.
         * @param {object} entry - The entry object.
         * @returns {string} The label ('Wish', 'Fact', 'Thought/Idea').
         */
        function getEntryTypeLabel(entry) {
            if (entry.type === 'wish') return 'Wish';
            // Check if it's a thought type before checking isFact
            if (entry.type === 'thought') return entry.isFact ? 'Fact' : 'Thought/Idea';
            if (entry.type === 'fact') return 'Fact'; // Handle starter facts
            return 'Contribution'; // Default fallback
        }

        /**
         * Shows a specific game section and hides others. Handles dynamic data loading.
         * @param {string} sectionId - The ID of the section div to show.
         */
        function showSection(sectionId) {
            // Hide all sections first
            document.querySelectorAll('.game-section').forEach(section => { section.classList.remove('active'); });
            // Find the section to show
            const element = document.getElementById(sectionId);
            if (element) {
                element.classList.add('active'); // Show it with animation
            } else {
                console.error("Section not found:", sectionId); return; // Log error if ID is wrong
            }

            // Reset build feedback message when entering/leaving build section
            if (buildFeedback) {
                buildFeedback.innerHTML = '<p>Awaiting your command, Commander!</p>';
                buildFeedback.className = 'build-feedback';
            }

            // Update the progress bar at the top
            const sections = ['intro', 'fun-facts', 'concept', 'feasibility', 'importance', 'build', 'share-thoughts', 'collected-questions', 'collected-wishes', 'conclusion'];
            const currentIndex = sections.indexOf(sectionId);
            const progressPercent = (currentIndex / (sections.length - 1)) * 100;
            progressBar.style.width = progressPercent + '%';

            // Update the cosmic sphere visual if the section has one
            updateCosmicVisuals(sectionId);

            // --- Load data dynamically when specific sections are shown ---
            // This uses the fetchDataFromBackend function to get fresh data
            if (sectionId === 'collected-questions') { populateCollectedQuestions(); }
            if (sectionId === 'collected-wishes') { populateCollectedWishes(); }
            if (sectionId === 'conclusion') {
                 finalizeResults(); // This calls populateFactWall to load the final combined list
                 // Reset save feedback message from previous attempts
                 saveFeedback.style.display = 'none'; saveFeedback.textContent = ''; saveFeedback.className = 'feedback';
            }
            // Ensure build section UI elements are updated when shown
            if (sectionId === 'build') {
                updateBuildResourcesDisplay(); updateBuildButtons(); updateEnergyCollectedDisplay();
            }
        }

        /**
         * Updates the score display on the page with a small animation.
         */
        function updateScoreDisplay() {
            scoreDisplay.textContent = score; // Update the number
            scoreDisplay.classList.add('resource-animation'); // Add animation class
            // Remove animation class after a short delay
            setTimeout(() => scoreDisplay.classList.remove('resource-animation'), 500);
        }


        // --- Build Section Specific Functions ---
        // These handle the logic for the "Build Your Own" section

        /** Updates the display for remaining Design Points. */
        function updateBuildResourcesDisplay() {
            const pointsText = currentResources;
            if(resourcesBuildDisplay) resourcesBuildDisplay.textContent = pointsText; // Update label
            if(resourcesBuild) resourcesBuild.textContent = pointsText; // Update counter
            if(resourcesBuild) { // Animate the counter
                resourcesBuild.classList.add('resource-animation');
                setTimeout(() => resourcesBuild.classList.remove('resource-animation'), 500);
            }
        }
        /** Calculates and updates the Blueprint Efficiency display. */
        function updateEnergyCollectedDisplay() {
             let calculatedEnergy = Math.min(100, // Cap at 100%
                (buildAllocations.phase1 * 10) + (buildAllocations.phase2 * 25) +
                (buildAllocations.phase3 * 8) + (buildAllocations.phase4 * 5)
             );
            energyCollected = Math.round(calculatedEnergy);
            if(energyCollectedDisplay) energyCollectedDisplay.textContent = energyCollected; // Update display
        }
        /** Executes a build phase: deducts points, updates state, gives feedback. */
        function runMissionPhase(phase, cost) {
             if (currentResources >= cost) { // Check if enough points
                 currentResources -= cost; // Deduct points
                 buildAllocations[phase] = (buildAllocations[phase] || 0) + 1; // Track phase completion
                 // Update displays
                 updateBuildResourcesDisplay(); updateEnergyCollectedDisplay(); updateBuildButtons();

                 let feedbackMsg = ""; let panelsToAdd = 0; let pointsEarned = 0;
                 buildFeedback.className = 'build-feedback success'; // Set feedback style

                 // Determine feedback, visuals, and points based on the phase chosen
                 switch (phase) {
                     case 'phase1': feedbackMsg = `<strong>Phase 1 Complete!</strong> Basic collector swarm deployed. <span class="sparkle">‚òÄÔ∏è</span>`; panelsToAdd = 1; pointsEarned = 5; break;
                     case 'phase2': feedbackMsg = `<strong>Phase 2 Complete!</strong> Power converters online. <span class="sparkle">‚ö°</span>`; panelsToAdd = 2; pointsEarned = 8; break;
                     case 'phase3': feedbackMsg = `<strong>Phase 3 Complete!</strong> Relay stations active. <span class="sparkle">üì°</span>`; panelsToAdd = 1; pointsEarned = 4; break;
                     case 'phase4': feedbackMsg = `<strong>Phase 4 Complete!</strong> Orbit stabilizers engaged. <span class="sparkle">üõ°Ô∏è</span>`; panelsToAdd = 1; pointsEarned = 6; break;
                 }
                 buildFeedback.innerHTML = `<p>${feedbackMsg}</p>`; // Show feedback message
                 addPanelToVisual(panelsToAdd); // Add visual panels to the sphere
                 score += pointsEarned; // Add fun points
                 updateScoreDisplay(); // Update score display

             } else { // Not enough points
                 buildFeedback.innerHTML = "<p>Mission Control reports insufficient Design Points!</p>";
                 buildFeedback.className = 'build-feedback info'; // Use different style for info message
             }
        }
        /** Enables/disables build phase buttons based on available points. */
        function updateBuildButtons() {
            document.querySelectorAll('.build-choices .build-btn').forEach(button => {
                const onclickAttr = button.getAttribute('onclick'); // Get the button's action
                // Extract the cost from the onclick attribute text
                const match = onclickAttr?.match(/runMissionPhase\('[^']+',\s*(\d+)\)/);
                if (match && match[1]) { // If cost found
                    const cost = parseInt(match[1]);
                    button.disabled = currentResources < cost; // Disable if not enough points
                } else { // Fallback if cost can't be determined
                    button.disabled = false;
                    console.warn("Could not determine cost for button:", button.id);
                }
            });
        }
        /** Adds panel elements to the 'build' section's visual sphere. */
        function addPanelToVisual(count = 1) {
            const container = document.getElementById('buildContainer'); if (!container) return;
            const panelCount = container.querySelectorAll('.cosmic-panel').length; if (panelCount >= MAX_PANELS) return; // Limit panels
            const panelsToAdd = Math.min(count, MAX_PANELS - panelCount); // Calculate how many can be added
            addMorePanels(container, panelsToAdd); // Call the function to actually add them
        }
        // --- End of Build Section Functions ---


        // --- Quiz and Submission Functions ---

        /**
         * Handles the selection of an option in a multiple-choice question.
         * @param {HTMLElement} element - The clicked option div.
         * @param {string} questionId - The ID of the question (e.g., 'concept').
         * @param {boolean} isCorrect - Whether the selected option is the correct answer.
         */
        function selectOption(element, questionId, isCorrect) {
            if (sectionState[questionId].answered) return; // Prevent answering twice
            sectionState[questionId].answered = true; // Mark as answered

            const feedbackElement = document.getElementById(`${questionId}-feedback`);
            const optionsContainer = document.getElementById(`${questionId}-options`);
            const nextButton = document.getElementById(`${questionId}-next`);

            // Disable all options for this question
            optionsContainer.querySelectorAll('.option').forEach(opt => {
                opt.onclick = null; // Remove click ability
                opt.classList.add('disabled'); // Add disabled style
                if (opt !== element) opt.style.opacity = '0.6'; // Dim unselected options
            });
            element.classList.add('selected'); // Style the selected option

            // Provide feedback and update score
            if (isCorrect) {
                score += 10; element.classList.add('correct'); // Add points and correct style
                feedbackElement.innerHTML = `<p><strong>Correct!</strong> ${getFeedbackText(questionId, true)}</p>`;
                feedbackElement.className = 'feedback correct'; // Show correct feedback box
            } else {
                score += 2; element.classList.add('incorrect'); // Add fewer points and incorrect style
                feedbackElement.innerHTML = `<p><strong>Not quite!</strong> ${getFeedbackText(questionId, false)}</p>`;
                feedbackElement.className = 'feedback incorrect'; // Show incorrect feedback box
                // Highlight the actual correct answer
                optionsContainer.querySelectorAll('.option').forEach(opt => {
                    const onclickAttrValue = opt.getAttribute('onclick'); // Check original onclick
                    if (onclickAttrValue && onclickAttrValue.includes(', true)')) { // Find the one marked as correct
                        opt.classList.add('correct'); opt.style.opacity = '1'; // Style it as correct
                    }
                });
            }
            updateScoreDisplay(); // Update score display
            nextButton.style.display = 'inline-block'; // Show the 'Next' button
        }

        /**
         * Returns specific feedback text for each quiz question.
         * @param {string} questionId - The ID of the question.
         * @param {boolean} isCorrect - Whether the user's answer was correct.
         * @returns {string} Feedback text.
         */
        function getFeedbackText(questionId, isCorrect) {
            // Provides explanatory text for quiz answers
            switch (questionId) {
                case 'concept': return isCorrect ? "Dyson proposed a 'swarm' of collectors. A solid shell is likely unstable!" : "While sci-fi loves solid shells, Dyson proposed a 'swarm' of many collectors. A solid shell would face huge gravitational stress!";
                case 'feasibility': return isCorrect ? "Exactly! The sheer amount of material needed is staggering - maybe needing entire planets!" : "While other factors are tricky, getting enough *stuff* (materials) is the biggest hurdle. We might need to dismantle planets!";
                case 'importance': return isCorrect ? "Right! It represents the ultimate energy goal for advanced civilizations and could be a sign of alien life (technosignature)." : "The main idea is capturing nearly ALL a star's energy. It's also a potential 'technosignature' ‚Äì a sign of advanced alien tech.";
                default: return ""; // Default empty feedback
            }
        }

        /**
         * Handles submission of a thought/fact/question. Stores it temporarily for final submission.
         * (Replaced with updated logic)
         */
        function submitThought() {
            const thoughtText = sharedThoughtInput.value.trim(); // Get text from input
            const isNotFact = sharedFactCheck.checked; // Check the checkbox

            if (thoughtText) { // Only proceed if text was entered
                const currentName = nameInput.value.trim() || userName; // Get name or use default
                const isFactActual = !isNotFact; // Determine if it's claimed as a fact
                const newEntry = { // Create an object for potential local display
                    text: thoughtText, name: currentName, isFact: isFactActual, type: 'thought'
                };

                // Store the data needed for the final POST request to the backend
                thoughtDataForSubmission = {
                    thought: thoughtText,
                    isFact: isFactActual // Remember if it was marked as a fact
                };
                sectionState.thoughtSubmittedThisSession = true; // Flag that a thought was entered

                // --- Update UI ---
                sharedThoughtInput.value = ''; // Clear the input box
                sharedFactCheck.checked = false; // Uncheck the box
                const originalText = submitThoughtButton.textContent; // Store original button text
                submitThoughtButton.textContent = 'Added!'; // Change button text temporarily
                submitThoughtButton.disabled = true; // Disable button temporarily
                setTimeout(() => { // After 1.5 seconds...
                    submitThoughtButton.textContent = originalText; // Restore button text
                    submitThoughtButton.disabled = false; // Re-enable button
                }, 1500);

                score += 5; // Award points for contributing
                updateScoreDisplay(); // Update score display

                // Optional: Add to local display immediately so user sees their contribution
                // This doesn't wait for backend confirmation but gives instant feedback
                 addEntryToWall(factWall, newEntry); // Add to main wall preview on conclusion page
                 if (document.getElementById('collected-questions').classList.contains('active')) {
                      addEntryToWall(collectedQuestionsList, newEntry); // Add to questions wall if currently visible
                 }

            } else {
                alert("Please share a thought or fact first!"); // Prompt if input is empty
            }
        }


        /**
         * NEW function to fetch data (thoughts or wishes) from the Google Apps Script backend.
         * @param {string} [type='thoughts'] - The type of data to fetch ('thoughts' or 'wishes').
         * @param {number} [limit=20] - The maximum number of items to fetch.
         * @returns {Promise<Array>} A promise that resolves to an array of fetched entries.
         */
        async function fetchDataFromBackend(type = 'thoughts', limit = 20) {
            // Safety check: Ensure the URL is not the placeholder
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_NEW_DEPLOYMENT_URL_HERE') {
                console.error("Google Apps Script URL is not set! Cannot fetch data.");
                // Don't alert here, just return empty to avoid spamming user
                return []; // Return empty array if URL is not set
            }
            try {
                // Construct the URL with query parameters for type and limit
                const fetchUrl = `${GOOGLE_SCRIPT_URL}?type=${type}&limit=${limit}`;
                // Ask the helper script for data using a GET request
                const response = await fetch(fetchUrl);
                // Check if the network request itself was successful
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                // Parse the JSON reply from the script
                const result = await response.json();
                // Check the status field within the JSON reply
                if (result.status === 'success') {
                    console.log(`Fetched ${result.data?.length || 0} ${type} from backend.`);
                    return result.data || []; // Return the array of data, or empty array if missing
                } else {
                    // Log error message if the script reported a failure
                    console.error("Backend Error:", result.message); return [];
                }
            } catch (error) {
                // Log error if the fetch itself failed (network issue, invalid URL, etc.)
                console.error(`Could not fetch ${type}:`, error); return [];
            }
        }

        /**
         * Populates the collected questions list by fetching data from the backend.
         * (Replaced with async version)
         */
        async function populateCollectedQuestions() {
            collectedQuestionsList.innerHTML = '<li>Loading questions...</li>'; // Show loading message
            const questionsAndThoughts = await fetchDataFromBackend('thoughts', 20); // Ask backend for thoughts
            collectedQuestionsList.innerHTML = ''; // Clear loading message
            if (questionsAndThoughts.length === 0) { // If no data returned
                 collectedQuestionsList.innerHTML = '<li>No questions or thoughts shared yet!</li>';
            } else {
                 // Display the thoughts fetched from the sheet
                 questionsAndThoughts.forEach(entry => addEntryToWall(collectedQuestionsList, entry));
            }
        }

        /**
         * Populates the collected wishes list by fetching data from the backend.
         * (Replaced with async version)
         */
        async function populateCollectedWishes() {
             collectedWishesList.innerHTML = '<li>Loading wishes...</li>'; // Show loading message
             const wishes = await fetchDataFromBackend('wishes', 30); // Ask backend for wishes
             collectedWishesList.innerHTML = ''; // Clear loading message
              if (wishes.length === 0) { // If no data returned
                 collectedWishesList.innerHTML = '<li>No birthday wishes yet!</li>';
              } else {
                 // Display wishes fetched from the sheet
                 wishes.forEach(entry => addEntryToWall(collectedWishesList, entry));
              }
        }

        /**
         * Populates the final wall on the conclusion page by fetching all contributions.
         * (Replaced with async version)
         */
        async function populateFactWall() {
            factWall.innerHTML = '<li>Loading contributions...</li>'; // Show loading message
            const thoughts = await fetchDataFromBackend('thoughts', 25); // Get recent thoughts
            const wishes = await fetchDataFromBackend('wishes', 25); // Get recent wishes

            // Combine fetched data with starter entries for a fuller list
            const allEntries = [...STARTER_ENTRIES, ...thoughts, ...wishes];

            // Optional: Remove duplicates if starter entries might get re-submitted
            // This creates a new list containing only unique entries based on text, name, and type
            const uniqueEntries = allEntries.filter((entry, index, self) =>
                 index === self.findIndex((e) => (
                     e.text === entry.text && e.name === entry.name && e.type === entry.type
                 ))
            );
             // Optional: Sort if timestamps are reliable and available in fetched data
             // uniqueEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            factWall.innerHTML = ''; // Clear loading message
             if (uniqueEntries.length === 0) { // If still empty after combining
                factWall.innerHTML = '<li>No contributions submitted yet!</li>';
             } else {
                 // Display all unique fetched entries
                uniqueEntries.forEach(entry => addEntryToWall(factWall, entry));
             }
        }

        /**
         * Submits the final results (score, name, wish, thought) to the Google Apps Script backend.
         * (Replaced with updated version using fetch and response handling)
         */
        async function submitBirthdayWish() {
            // --- Safety check: Ensure the backend URL is configured ---
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_NEW_DEPLOYMENT_URL_HERE') {
                 console.error("Google Apps Script URL is not set!");
                 alert("Error: Cannot save results, backend connection not configured.");
                 saveFeedback.textContent = 'Error: Backend connection not configured.';
                 saveFeedback.className = 'feedback save-error';
                 saveFeedback.style.display = 'block';
                 return; // Stop execution if URL is missing
             }

            // --- Prevent double submission ---
            if (sectionState.wishSubmitted) { alert("You've already submitted your wish and results!"); return; }

            // --- Get user inputs ---
            const wishText = birthdayWishInput.value.trim();
            const finalName = nameInput.value.trim();

            // --- Validate inputs ---
            if (!finalName) { alert("Please enter your name to sign your wish and save results!"); nameInput.focus(); return; }
            userName = finalName; displayName.textContent = userName; // Update name globally and on page
            if (!wishText) { alert("Please write a birthday wish for Mary!"); birthdayWishInput.focus(); return; }

            // --- Prepare Data to Send to the backend ---
            const dataToSend = {
                name: userName,
                score: score,
                efficiency: energyCollected,
                // Include thought details only if one was submitted in this session
                thought: sectionState.thoughtSubmittedThisSession ? thoughtDataForSubmission?.thought : null,
                isFact: sectionState.thoughtSubmittedThisSession ? thoughtDataForSubmission?.isFact : null,
                wish: wishText,
                timestamp: new Date().toISOString() // Add current time
            };

            // --- Update UI to show "Saving..." ---
            submitWishButton.disabled = true; // Disable button during save
            submitWishButton.textContent = 'Saving...';
            saveFeedback.textContent = 'Saving your results...';
            saveFeedback.className = 'feedback saving'; // Apply 'saving' style
            saveFeedback.style.display = 'block'; // Make feedback visible

            // --- Try Sending the Data to Google Apps Script ---
            try {
                // Use 'fetch' to send data via POST
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    cache: 'no-cache', // Don't use cached versions
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Send data as plain text
                    body: JSON.stringify(dataToSend) // Convert the data object to a JSON string
                });

                // Wait for the reply from the script and parse it as JSON
                const result = await response.json();

                // Check the 'status' field in the reply from the script
                if (result.status === "success") { // Hooray! The script confirmed success!
                    saveFeedback.textContent = 'Results saved successfully! Thank you!';
                    saveFeedback.className = 'feedback save-success'; // Apply 'success' style
                    sectionState.wishSubmitted = true; // Mark as submitted
                    thoughtDataForSubmission = null; // Clear temporary thought data
                    sectionState.thoughtSubmittedThisSession = false; // Reset flag
                    submitWishButton.textContent = "Results Saved!"; // Keep button disabled, show confirmation

                    score += 10; // Award bonus points for submitting
                    updateScoreDisplay(); // Update score display
                    startConfetti(); // Celebrate!

                    // Optionally add the wish to the local walls immediately after successful save
                    // This provides instant visual confirmation on the current page
                    const newWishEntry = { text: wishText, name: userName, isFact: false, type: 'wish' };
                    addEntryToWall(factWall, newWishEntry); // Add to final wall
                    if (document.getElementById('collected-wishes').classList.contains('active')) {
                        addEntryToWall(collectedWishesList, newWishEntry); // Add to wishes wall if visible
                    }
                } else { // Uh oh, the script reported an error in its reply
                    throw new Error(result.message || "Unknown error reported by backend.");
                }

            } catch (error) { // Catch errors during fetch or if the script reply wasn't successful JSON
                console.error('Error sending data or processing response:', error);
                saveFeedback.textContent = `Error saving results: ${error.message}. Your wish might not be saved online.`;
                saveFeedback.className = 'feedback save-error'; // Apply 'error' style
                submitWishButton.textContent = "Save Failed (Retry?)"; // Change button text
                submitWishButton.disabled = false; // Re-enable button to allow retry
            }
        }

        /**
         * Updates the final score/name display and populates the main contribution wall.
         * (Replaced with async version to wait for populateFactWall)
         */
        async function finalizeResults() { // Make it async because it calls an async function
            finalScoreDisplay.textContent = score; // Update final score display
            finalEnergyDisplay.textContent = energyCollected; // Update final efficiency display
            displayName.textContent = nameInput.value.trim() || userName; // Update displayed name
            await populateFactWall(); // Wait for the final contribution wall to load data from backend
        }


        // --- Visual Effect Functions (Mostly Unchanged) ---
        // These handle the animations and dynamic visuals like the cosmic sphere and confetti

        /** Updates the cosmic sphere visualization based on the current section. */
        function updateCosmicVisuals(sectionId) {
             // Clear visuals from other sections first
             ['conceptContainer', 'feasibilityContainer', 'importanceContainer', 'buildContainer'].forEach(id => {
                 if (id !== `${sectionId}Container`) { clearCosmicVisuals(id); }
             });
             const container = document.getElementById(`${sectionId}Container`); if (!container) return;
             // Ensure the star is always present
             if (!container.querySelector('.star')) { const star = document.createElement('div'); star.className = 'star'; container.appendChild(star); }
             // Add elements based on the current section
             switch (sectionId) {
                 case 'concept': break; // Just the star
                 case 'feasibility': addCosmicRing(container); break; // Star + Ring
                 case 'importance': addCosmicRing(container); addMorePanels(container, 5); break; // Star + Ring + Some Panels
                 case 'build': completeDysonSwarmVisual(container); break; // Star + Ring + Panels based on build choices
             }
        }
        /** Removes rings and panels from a specified visual container. */
        function clearCosmicVisuals(containerId) {
             const container = document.getElementById(containerId);
             if (container) { const elementsToRemove = container.querySelectorAll('.cosmic-ring, .cosmic-panel'); elementsToRemove.forEach(el => el.remove()); }
        }
        /** Adds the rotating cosmic ring visual to a container. */
        function addCosmicRing(targetContainer) {
             if (!targetContainer || targetContainer.querySelector('.cosmic-ring')) return; // Don't add if exists
             const ring = document.createElement('div'); ring.className = 'cosmic-ring'; targetContainer.appendChild(ring);
             void ring.offsetWidth; // Trigger reflow for animation
             ring.style.opacity = '1'; // Make it visible
        }
        /** Adds a specified number of orbiting panel visuals to a container. */
        function addMorePanels(targetContainer, count) {
             if (!targetContainer) return;
             if (!targetContainer.querySelector('.cosmic-ring')) { addCosmicRing(targetContainer); } // Ensure ring exists
             const radius = 75; // Orbit radius
             const existingPanels = targetContainer.querySelectorAll('.cosmic-panel').length; // Count existing panels
             for (let i = 0; i < count; i++) { // Loop to add 'count' panels
                 if (existingPanels + i >= MAX_PANELS) break; // Stop if max panels reached
                 const panelIndex = existingPanels + i;
                 // Calculate position around the ring
                 const angle = (panelIndex / Math.max(1, MAX_PANELS)) * 2 * Math.PI + (Math.random() * 0.3 - 0.15); // Distribute evenly + randomness
                 const x = radius * Math.cos(angle); const y = radius * Math.sin(angle);
                 // Create panel element
                 const panel = document.createElement('div'); panel.className = 'cosmic-panel';
                 // Position and rotate panel, start scaled down and invisible
                 panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(0.1)`; panel.style.opacity = '0';
                 targetContainer.appendChild(panel); // Add to page
                 // Animate appearance with a slight delay for each panel
                 setTimeout(() => { panel.style.opacity = '0.7'; panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(1)`; }, 50 * i);
             }
        }
        /** Draws the complete Dyson Swarm visual based on completed build phases. */
        function completeDysonSwarmVisual(targetContainer) {
             if (!targetContainer) return;
             clearCosmicVisuals(targetContainer.id); // Clear previous visuals
             addCosmicRing(targetContainer); // Add the ring
             // Calculate how many panels to show based on phases completed
             const numPanels = Math.min(MAX_PANELS,
                (buildAllocations.phase1 * 2) + (buildAllocations.phase2 * 3) +
                (buildAllocations.phase3 * 1) + (buildAllocations.phase4 * 1)
             );
             addMorePanels(targetContainer, numPanels); // Add the calculated panels
        }
        // --- Confetti Functions ---
        let confettiInterval = null; // Variable to control confetti generation
        /** Starts the confetti animation for 5 seconds. */
        function startConfetti() { stopConfetti(); createConfettiPiece(); confettiInterval = setInterval(createConfettiPiece, 100); setTimeout(stopConfetti, 5000); }
        /** Stops the confetti animation and clears pieces. */
        function stopConfetti() { clearInterval(confettiInterval); confettiInterval = null; setTimeout(() => { if (confettiContainer) confettiContainer.innerHTML = ''; }, 3000); }
        /** Creates a single piece of falling confetti. */
        function createConfettiPiece() { if (!confettiContainer) return; const confetti = document.createElement('div'); const randomClass = `c${Math.floor(Math.random() * 5)}`; confetti.className = `confetti ${randomClass}`; confetti.style.left = `${Math.random() * 100}vw`; confetti.style.animationDelay = `${Math.random() * 2}s`; confetti.style.transform = `rotate(${Math.random() * 360}deg)`; confettiContainer.appendChild(confetti); setTimeout(() => { confetti.remove(); }, 7000); } // Remove after animation finishes

    </script>
    </body>
</html>

