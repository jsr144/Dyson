<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Curiosity Explorer: For Mary's Science Fair Birthday!</title>
    <style>
        /* Basic variables and styles */
        :root {
            --primary: #6d28d9; /* Deep Purple */
            --secondary: #ec4899; /* Bright Pink */
            --accent: #f59e0b; /* Amber */
            --light: #fdf2f8; /* Very Light Pink */
            --dark: #1e1b4b; /* Dark Indigo */
            --success: #10b981; /* Emerald Green */
            --info: #3b82f6; /* Blue */
            --white: #ffffff;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; /* Fun, kid-friendly font */
            line-height: 1.6;
            color: var(--dark);
            background-color: var(--light);
            background-image: linear-gradient(120deg, #fdf2f8 0%, #e0f2fe 100%); /* Light gradient background */
            margin: 0;
            padding: 1rem; /* Added padding for smaller screens */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Main content container */
        .container {
            width: 90%;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border: 3px dashed var(--secondary); /* Dashed pink border */
        }

        /* Headings */
        h1, h2, h3 {
            color: var(--primary);
            font-weight: 700;
            text-align: center;
        }

        h1 {
            margin-bottom: 1.5rem;
            font-size: 2.2rem; /* Slightly smaller for better fit */
            background: linear-gradient(120deg, var(--primary), var(--secondary)); /* Gradient text */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent; /* Use transparent text color to show gradient */
            -webkit-text-fill-color: transparent; /* For Safari */
        }

        h2 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.6rem; /* Slightly smaller */
            color: var(--secondary);
        }

        h3 {
             font-size: 1.3rem;
             margin-bottom: 0.8rem; /* Added margin bottom */
        }

        /* Paragraphs */
        p {
            margin-bottom: 1rem;
            font-size: 1rem; /* Slightly smaller for conciseness */
        }

        /* Birthday Banner */
        .birthday-banner {
            text-align: center;
            padding: 0.8rem; /* Reduced padding */
            background-color: rgba(236, 72, 153, 0.1); /* Light pink background */
            border-radius: 10px;
            margin-bottom: 1.5rem;
        }

        .birthday-banner p {
            font-size: 1.1rem; /* Slightly smaller */
            font-weight: bold;
            color: var(--secondary);
            margin: 0;
        }

        /* Game Sections */
        .game-section {
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Smooth transition */
        }

        .game-section.active {
            display: block; /* Show active section */
            opacity: 1;
            transform: translateY(0);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background-color: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.7rem 1.4rem; /* Slightly smaller padding */
            margin: 0.5rem 0.25rem;
            border-radius: 50px; /* Rounded pill shape */
            font-size: 0.95rem; /* Slightly smaller font */
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit; /* Use body font */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary);
            transform: translateY(-3px) scale(1.05); /* Lift and scale effect */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            background-color: #cccccc; /* Grey out disabled buttons */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7; /* Make disabled buttons slightly transparent */
        }

        .btn-next { background-color: var(--accent); float: right; }
        .btn-prev { background-color: var(--info); float: left; }
        .btn-submit { background-color: var(--success); display: block; margin: 1rem auto; }
        .btn-restart { background-color: var(--primary); display: block; margin: 1rem auto; } /* Style retained but button removed */
        .btn-email { background-color: var(--info); display: block; margin: 1rem auto; } /* Style retained but button removed */


        /* Options for multiple choice */
        .options {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around; /* Better spacing */
            margin: 1.5rem 0;
        }

        .option {
            flex-basis: calc(50% - 1rem); /* Two columns with gap */
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: rgba(59, 130, 246, 0.1); /* Light blue background */
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Include padding and border in width */
        }

        .option:hover {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: var(--info);
            transform: translateY(-3px);
        }

        .option.selected { background-color: rgba(236, 72, 153, 0.2); border-color: var(--secondary); }
        .option.correct { background-color: rgba(16, 185, 129, 0.2); border-color: var(--success); cursor: default; }
        .option.incorrect { background-color: rgba(245, 158, 11, 0.2); border-color: var(--accent); cursor: default; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; } /* Style for disabled options after answering */

        /* Feedback messages */
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 15px;
            display: none; /* Hidden by default */
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
        }

        .feedback.correct { background-color: rgba(16, 185, 129, 0.1); border-left-color: var(--success); display: block; }
        .feedback.incorrect { background-color: rgba(245, 158, 11, 0.1); border-left-color: var(--accent); display: block; }

        /* Score Display */
        .score-display {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        /* Cosmic Sphere Visualization */
        .cosmic-sphere-container {
            position: relative;
            width: 250px; /* Smaller size */
            height: 250px;
            margin: 1.5rem auto; /* Reduced margin */
            perspective: 1000px; /* For 3D effects if needed */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .star {
            position: absolute;
            width: 80px; /* Smaller star */
            height: 80px;
            background: radial-gradient(circle, #FFDA63, #FF9800); /* Brighter yellow gradient */
            border-radius: 50%;
            box-shadow: 0 0 25px 8px rgba(255, 193, 7, 0.6); /* Adjusted shadow */
            z-index: 1; /* Star is behind elements */
        }

        .cosmic-ring {
            position: absolute;
            border: 4px dashed rgba(236, 72, 153, 0.7); /* Dashed ring */
            border-radius: 50%;
            width: 150px; /* Ring size */
            height: 150px;
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.5);
            animation: rotate 20s linear infinite;
            z-index: 2; /* Ring above star */
            opacity: 0; /* Initially hidden */
            transition: opacity 0.5s ease-in-out;
        }

        .cosmic-panel {
            position: absolute;
            width: 20px;
            height: 30px;
            background-color: rgba(109, 40, 217, 0.6); /* Semi-transparent purple */
            border: 1px solid rgba(109, 40, 217, 0.9);
            border-radius: 4px;
            transform-origin: center;
            box-shadow: 0 0 5px rgba(109, 40, 217, 0.5);
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0; /* Initially hidden */
            z-index: 3; /* Panels above ring */
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: rgba(59, 130, 246, 0.2);
            border-radius: 50px;
            margin-bottom: 1rem;
            overflow: hidden;
            height: 15px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        /* Clearfix for floated elements */
        .clearfix::after { content: ""; clear: both; display: table; }

        /* Resource Counter */
        .resource-counter {
            font-size: 1rem;
            text-align: right;
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        .resource-animation { animation: pulse 0.5s ease-in-out; }

        /* Wall of Facts / Contributions / Wishes */
        .contributions-wall { /* Renamed for clarity */
            background-color: rgba(16, 185, 129, 0.1); /* Light green background */
            border-radius: 15px;
            padding: 1rem;
            margin: 1.5rem 0;
            max-height: 300px;
            overflow-y: auto; /* Scroll if content overflows */
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .contributions-wall h3 {
            color: var(--success);
            text-align: center;
            border-bottom: 2px dashed var(--success);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        .contributions-wall ul { list-style-type: none; padding: 0; }

        .contributions-wall li {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background-color: var(--white);
            border-radius: 10px;
            border-left: 3px solid var(--success);
            font-size: 0.9rem; /* Slightly smaller text */
            word-wrap: break-word; /* Prevent long text overflow */
        }
        .contributions-wall li.not-fact {
            border-left-color: var(--info); /* Different color for non-facts */
        }
        .contributions-wall li.wish {
            border-left-color: var(--secondary); /* Different color for wishes */
        }

        .fact-attribution {
            font-style: italic;
            font-size: 0.75rem; /* Smaller attribution */
            color: var(--primary);
            margin-top: 0.3rem;
            display: block; /* Ensure it's on its own line */
        }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--primary);
            font-size: 0.95rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.7rem; /* Slightly smaller padding */
            border-radius: 10px;
            border: 2px solid rgba(109, 40, 217, 0.3);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Include padding in width */
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea { min-height: 80px; resize: vertical; }

        .input-hint {
            font-size: 0.75rem; /* Smaller hint text */
            color: var(--secondary);
            margin-top: 0.3rem;
        }

        /* Congratulations Container */
        .congrats-container { text-align: center; margin: 2rem 0; }

        /* Confetti Animation */
        .confetti-container {
            position: fixed; /* Cover the whole screen */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks through */
            overflow: hidden;
            z-index: 1000; /* Above everything */
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: var(--secondary);
            opacity: 0.7;
            animation: confetti-fall 3s linear infinite;
        }
        .confetti.c1 { background-color: var(--primary); animation-duration: 3.5s; }
        .confetti.c2 { background-color: var(--accent); animation-duration: 2.5s; }
        .confetti.c3 { background-color: var(--success); animation-duration: 4s; }
        .confetti.c4 { background-color: var(--info); animation-duration: 3.2s; }


        /* Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 0.5rem;
            width: 16px; /* Slightly smaller */
            height: 16px;
            accent-color: var(--primary); /* Style the checkmark color */
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 0.85rem; /* Smaller label */
            color: var(--primary);
            margin-bottom: 0; /* Override default label margin */
            font-weight: normal; /* Normal weight */
            cursor: pointer;
        }

        /* Sparkle Effect */
        .sparkle { display: inline-block; animation: sparkle 1.5s infinite ease-in-out; }

        /* Mary Says Quote Box */
        .mary-says {
            background-color: rgba(236, 72, 153, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 15px 15px 0;
            font-style: italic;
            font-size: 0.9rem;
        }

        /* Fun Facts List */
        .fun-facts-list {
            list-style-type: '‚ú®'; /* Use sparkle emoji as bullet */
            padding-left: 2rem;
            margin: 1.5rem 0;
        }
        .fun-facts-list li {
            margin-bottom: 0.8rem;
            padding-left: 0.5rem;
            font-size: 0.95rem;
        }

        /* Styles for the Revamped Build Section */
        .build-choices {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; /* Space out buttons */
            margin: 1.5rem 0;
        }

        .build-choices .btn.build-btn {
            flex-basis: calc(50% - 1rem); /* Two columns layout */
            margin-bottom: 1rem;
            padding: 1rem; /* More padding for description */
            height: auto; /* Allow button height to adjust */
            text-align: left; /* Align text left */
            display: flex; /* Use flexbox for content alignment */
            flex-direction: column; /* Stack title and description */
            box-shadow: 0 3px 5px rgba(0,0,0, 0.1); /* Softer shadow */
            background-color: var(--info); /* Use info color */
            line-height: 1.4; /* Better spacing for text */
            border-radius: 15px; /* Less rounded than pill */
        }

        .build-choices .btn.build-btn:hover {
            background-color: var(--primary); /* Use primary on hover */
             transform: translateY(-2px) scale(1.02); /* Subtle hover effect */
        }

         .build-choices .btn.build-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
         }


        .build-choices .btn.build-btn strong {
            display: block;
            margin-bottom: 0.5rem; /* Space between title and desc */
            font-size: 1rem; /* Slightly larger title */
            color: var(--white); /* Ensure title is white */
        }

        .choice-desc {
            font-size: 0.85rem; /* Smaller description text */
            color: rgba(255, 255, 255, 0.9); /* Lighter text for description */
        }

        .build-feedback {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            background-color: rgba(236, 72, 153, 0.1); /* Light pink background */
            border-left: 4px solid var(--secondary); /* Pink border */
            min-height: 50px; /* Ensure space even when empty */
            transition: background-color 0.3s ease;
            font-size: 0.95rem;
        }
        .build-feedback.success {
             background-color: rgba(16, 185, 129, 0.1); /* Light green for success */
             border-left-color: var(--success);
        }
        .build-feedback.info {
             background-color: rgba(59, 130, 246, 0.1); /* Light blue for info */
             border-left-color: var(--info);
        }


        .build-results {
            margin-top: 1rem;
            padding: 0.5rem;
            background-color: rgba(109, 40, 217, 0.05); /* Very light purple */
            border-radius: 8px;
            text-align: center;
        }
        .build-results p {
            margin: 0.3rem 0;
        }
        .build-results strong {
             color: var(--primary);
        }

        /* Keyframe Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); } /* Smaller pulse */
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; } /* Adjusted sparkle */
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .container { padding: 1rem; width: 95%; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.4rem; }
            p { font-size: 0.95rem; }
            .option { flex-basis: 100%; } /* Stack options vertically */
            .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
            .cosmic-sphere-container { width: 200px; height: 200px; }
            .star { width: 60px; height: 60px; }
            .cosmic-ring { width: 120px; height: 120px; }
            .fun-facts-list { padding-left: 1.5rem; }
             /* Responsive adjustments for build section */
            .build-choices .btn.build-btn {
                flex-basis: 100%; /* Stack buttons vertically on small screens */
            }
        }

    </style>
</head>
<body>
    <div class="confetti-container" id="confettiContainer"></div>

    <div class="container">
        <div class="birthday-banner">
            <p><span class="sparkle">‚ú®</span> For Mary's Birthday Science Fair! <span class="sparkle">‚ú®</span></p>
        </div>

        <h1>Cosmic Curiosity Explorer</h1>
        <p class="score-display">Fun Points: <span id="score">0</span></p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="game-section active" id="intro">
            <h2>Welcome, Science Fair Explorer!</h2>
            <p>You've found an exhibit on the <strong>Dyson Sphere</strong> - a giant structure around a star to capture its energy!</p>
            <div class="mary-says">
                "This is the year my dreams will come true (why not?)" - Mary
            </div>
            <p>In this adventure, you'll:</p>
            <ul>
                <li>Learn about this huge cosmic idea.</li>
                <li>See some fun facts.</li>
                <li>Share your thoughts and questions.</li>
                <li>See what others wondered.</li>
                <li>Leave a birthday wish for Mary!</li>
            </ul>
            <p class="resource-counter">Curiosity Points: <span id="resources-intro">100</span></p> <div class="clearfix">
                <button class="btn btn-next" onclick="showSection('fun-facts')">See Fun Facts! ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="fun-facts">
            <h2><span class="sparkle">‚ú®</span> Dyson Sphere Fun Facts! <span class="sparkle">‚ú®</span></h2>
            <p>Get ready for some mind-blowing ideas!</p>
            <ul class="fun-facts-list" id="fun-facts-list">
                </ul>
             <div class="mary-says">
                Astronomers actually look for Dyson Spheres around other stars as potential signs of advanced extraterrestrial civilizations!
            </div>
            <div class="clearfix">
                 <button class="btn btn-prev" onclick="showSection('intro')">‚Üê Back</button>
                <button class="btn btn-next" onclick="showSection('concept')">What IS It? ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="concept">
            <h2>What's a Dyson Sphere?</h2>
            <div class="cosmic-sphere-container" id="conceptContainer">
                <div class="star"></div>
            </div>
            <p>In 1960, Freeman Dyson imagined advanced civilizations building huge structures around stars to catch ALL their energy.</p>
            <p>What form did Dyson suggest this might take?</p>
            <div class="options" id="concept-options">
                <div class="option" onclick="selectOption(this, 'concept', false)">A solid shell around a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', true)">A swarm of collectors orbiting a star.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A giant space vacuum for star energy.</div>
                <div class="option" onclick="selectOption(this, 'concept', false)">A magic sphere to make stars last forever.</div>
            </div>
            <div class="feedback" id="concept-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('fun-facts')">‚Üê Back</button>
                <button class="btn btn-next" id="concept-next" style="display: none;" onclick="showSection('feasibility'); addCosmicRing();">Explore Feasibility ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="feasibility">
            <h2>Could We Build One?</h2>
             <div class="cosmic-sphere-container" id="feasibilityContainer">
                <div class="star"></div>
                 </div>
            <p>What's the biggest challenge in building a Dyson Swarm?</p>
            <div class="options" id="feasibility-options">
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting the star's permission.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Inventing super-efficient solar panels.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', true)">Getting enough building materials.</div>
                <div class="option" onclick="selectOption(this, 'feasibility', false)">Getting all countries to agree.</div>
            </div>
            <div class="feedback" id="feasibility-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('concept')">‚Üê Back</button>
                <button class="btn btn-next" id="feasibility-next" style="display: none;" onclick="showSection('importance'); addMorePanels();">Why Bother? ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="importance">
            <h2>Why Is It Important?</h2>
             <div class="cosmic-sphere-container" id="importanceContainer">
                <div class="star"></div>
                 </div>
            <p>Even if hard to build, why is the Dyson Sphere concept useful?</p>
            <div class="options" id="importance-options">
                <div class="option" onclick="selectOption(this, 'importance', false)">It's a great space umbrella.</div>
                <div class="option" onclick="selectOption(this, 'importance', true)">It represents ultimate energy capture.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It's mainly for sci-fi stories.</div>
                <div class="option" onclick="selectOption(this, 'importance', false)">It helps send messages to aliens.</div>
            </div>
            <div class="feedback" id="importance-feedback"></div>
            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('feasibility')">‚Üê Back</button>
                <button class="btn btn-next" id="importance-next" style="display: none;" onclick="showSection('build'); completeDysonSwarmVisual();">Build Your Own! ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="build">
            <h2>Mission Control: Dyson Swarm Design</h2>
            <p>Let's design our Dyson Swarm blueprint! You have <strong id="resources-build-display">100</strong> Design Points to allocate.</p>
            <p>Choose mission phases to add components and improve efficiency. Each phase adds a crucial part to our plan!</p>

            <div class="cosmic-sphere-container" id="buildContainer">
                <div class="star"></div>
                </div>

            <div class="build-choices">
                <button class="btn build-btn" id="btn-phase1" onclick="runMissionPhase('phase1', 25)">
                    <strong>Phase 1: Deploy Collectors (-25 Pts)</strong>
                    <span class="choice-desc">Launch basic solar collectors into orbit. Starts gathering energy.</span>
                </button>
                <button class="btn build-btn" id="btn-phase2" onclick="runMissionPhase('phase2', 30)">
                    <strong>Phase 2: Add Power Converters (-30 Pts)</strong>
                    <span class="choice-desc">Install systems to convert raw sunlight into usable power. Boosts efficiency significantly.</span>
                </button>
                <button class="btn build-btn" id="btn-phase3" onclick="runMissionPhase('phase3', 20)">
                    <strong>Phase 3: Build Relay Stations (-20 Pts)</strong>
                    <span class="choice-desc">Construct stations to beam collected energy back home (or wherever it's needed!). Improves delivery.</span>
                </button>
                <button class="btn build-btn" id="btn-phase4" onclick="runMissionPhase('phase4', 25)">
                    <strong>Phase 4: Implement Stabilizers (-25 Pts)</strong>
                    <span class="choice-desc">Add systems to keep the swarm stable and prevent collisions. Increases reliability.</span>
                </button>
            </div>

            <div class="build-feedback" id="build-feedback">
                <p>Awaiting your command, Commander!</p>
            </div>

            <div class="build-results">
                <p>Blueprint Efficiency: <strong id="energy-collected">0</strong>%</p>
                <p class="resource-counter">Design Points Left: <strong id="resources-build">100</strong></p>
            </div>

            <div class="clearfix">
                <button class="btn btn-prev" onclick="showSection('importance')">‚Üê Back</button>
                <button class="btn btn-next" id="build-next" onclick="showSection('share-thoughts')">Share Your Thoughts ‚Üí</button>
            </div>
        </div>

        <div class="game-section" id="share-thoughts">
             <h2>Share Your Cosmic Curiosities!</h2>
             <p>Got a cool fact, a burning question, or a wild idea about Dyson Spheres or space energy?</p>
             <p>Add it here for Mary's collection!</p>
             <div class="form-group">
                 <label for="shared-thought">Your Fact, Thought, or Question:</label>
                 <textarea id="shared-thought" placeholder="e.g., A cool fact is... / I wonder about... / What if...?"></textarea>
                 <div class="checkbox-container">
                     <input type="checkbox" id="shared-fact-check">
                     <label for="shared-fact-check" class="checkbox-label">This is NOT a verified fact (it's an idea, question, or opinion).</label>
                 </div>
                 <button class="btn btn-submit" id="submit-thought-button" onclick="submitThought()">Add to Collection</button>
             </div>
              <div class="mary-says">
                 Dyson spheres captivate our imagination as megastructures that could harness the entire energy output of a star,
                 representing an engineering feat so advanced it borders on magic while demonstrating how truly vast our technological potential might be.
                 This concept naturally leads us to wonder what other cosmic engineering marvels might be possible and what advanced civilizations across the universe
                 might have already achieved.
             </div>
             <div class="clearfix">
                 <button class="btn btn-prev" onclick="showSection('build')">‚Üê Back</button>
                 <button class="btn btn-next" onclick="showSection('collected-questions'); populateCollectedQuestions();">See Collected Questions ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="collected-questions">
             <h2>Collected Questions & Ideas</h2>
             <p>Here's what other explorers (and maybe you!) have wondered:</p>
             <div class="contributions-wall">
                 <h3>Cosmic Question Corner</h3>
                 <ul id="collected-questions-list">
                     </ul>
             </div>
             <div class="clearfix">
                  <button class="btn btn-prev" onclick="showSection('share-thoughts')">‚Üê Back</button>
                  <button class="btn btn-next" onclick="showSection('collected-wishes'); populateCollectedWishes();">See Birthday Wishes ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="collected-wishes">
             <h2>Birthday Wishes for Mary!</h2>
             <p>Let's celebrate Mary's birthday with these awesome messages:</p>
             <div class="contributions-wall">
                 <h3>Happy Birthday Wall!</h3>
                 <ul id="collected-wishes-list">
                      </ul>
             </div>
              <div class="mary-says">
                 "Thank you all for the wonderful wishes!" - Mary (probably!)
             </div>
             <div class="clearfix">
                  <button class="btn btn-prev" onclick="showSection('collected-questions')">‚Üê Back</button>
                  <button class="btn btn-next" onclick="showSection('conclusion'); finalizeResults();">Final Results & Wish ‚Üí</button>
             </div>
        </div>

        <div class="game-section" id="conclusion">
            <div class="congrats-container">
                <h2>Thanks for Exploring, <span id="display-name">Explorer</span>!</h2>
                <p>Final Fun Points: <span id="final-score">0</span></p>
                <p>Your Blueprint Efficiency: <span id="final-energy">0</span>%</p> </div>

            <div class="form-group">
                <label for="name-input">Your Name (to sign your wish):</label>
                <input type="text" id="name-input" placeholder="Your Name">

                <label for="birthday-wish">Birthday wishes for Mary?</label>
                <textarea id="birthday-wish" placeholder="e.g., Happy Birthday Mary! Have a stellar day!"></textarea>
                <button class="btn btn-submit" id="submit-wish-button" onclick="submitBirthdayWish()">Add Your Wish & Celebrate!</button>
            </div>

             <div class="contributions-wall">
                 <h3>Wall of ALL Contributions</h3>
                 <p style="text-align: center; font-size: 0.9em;">Facts, Thoughts & Wishes from Mary's Science Fair:</p>
                 <ul id="fact-wall">
                      </ul>
             </div>

             <div class="mary-says">
                 "Science fair is an invitation to follow your curiosity. The point is JOY, so only do this if it feels fun!" - Mary
             </div>

             <div class="clearfix"> <button class="btn btn-prev" onclick="showSection('collected-wishes')">‚Üê Back</button>
              </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const LOCAL_STORAGE_KEY = 'cosmicFacts_v3'; // Updated key for new structure/gameplay
        const MAX_PANELS = 12; // Max panels for visualization
        const DYSON_FUN_FACTS = [
            "A Dyson Sphere aims to capture nearly 100% of a star's energy output.",
            "The most likely design isn't a solid shell, but a 'Dyson Swarm' of many orbiting collectors.",
            "Building a Dyson Swarm around our Sun might require dismantling planets like Jupiter for materials!",
            "If aliens built one, it might block visible light but glow brightly in infrared (heat).",
            "The Kardashev Scale ranks civilizations by energy use; Dyson Sphere builders are Type II.",
            "Finding a Dyson Sphere is a key goal in the Search for Extraterrestrial Intelligence (SETI).",
            "Some stars show strange dimming patterns (like Tabby's Star) that *might* hint at megastructures, but natural causes are more likely.",
            "Even a partial Dyson Swarm could provide vastly more energy than Earth currently uses.",
            "The collectors in a swarm would need advanced AI and propulsion to avoid colliding.",
            "Freeman Dyson proposed the idea in a 1960 science paper, inspired by sci-fi!"
        ];
        const STARTER_ENTRIES = [ // Default entries if localStorage is empty
            { text: "Our sun makes enough energy in 1 second for humanity's needs for 500,000 years!", name: "Claude", isFact: true, type: 'fact' },
            { text: "Could Dyson Spheres create artificial habitats inside?", name: "Science Friend", isFact: false, type: 'thought' },
            { text: "What if we connected Dyson Spheres around multiple stars?", name: "Cosmic Explorer", isFact: false, type: 'thought' }
        ];

        // --- State Variables ---
        let score = 0;
        let currentResources = 100; // Renamed to 'Design Points' in UI text, but variable name kept for simplicity
        let energyCollected = 0; // Represents 'Blueprint Efficiency'
        let userName = "Explorer"; // Default name
        // Updated buildAllocations to track phases
        let buildAllocations = {
            phase1: 0, phase2: 0, phase3: 0, phase4: 0
        };
        // Keep track of answered questions and submissions
        let sectionState = {
            'concept': { answered: false },
            'feasibility': { answered: false },
            'importance': { answered: false },
            'thoughtSubmitted': false,
            'wishSubmitted': false
        };
        // Store all collected responses/facts/wishes - Loaded from localStorage
        let collectedEntries = [];

        // --- DOM Elements (cache them) ---
        const scoreDisplay = document.getElementById('score');
        const progressBar = document.getElementById('progressBar');
        const factWall = document.getElementById('fact-wall');
        const collectedQuestionsList = document.getElementById('collected-questions-list');
        const collectedWishesList = document.getElementById('collected-wishes-list');
        const funFactsList = document.getElementById('fun-facts-list');
        const nameInput = document.getElementById('name-input');
        const birthdayWishInput = document.getElementById('birthday-wish');
        const sharedThoughtInput = document.getElementById('shared-thought');
        const sharedFactCheck = document.getElementById('shared-fact-check');
        const displayName = document.getElementById('display-name');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalEnergyDisplay = document.getElementById('final-energy');
        // Build section specific elements
        const resourcesBuildDisplay = document.getElementById('resources-build-display'); // Label above visual
        const resourcesBuild = document.getElementById('resources-build'); // Counter in results below
        const energyCollectedDisplay = document.getElementById('energy-collected'); // Efficiency display below
        const buildFeedback = document.getElementById('build-feedback'); // Feedback box
        // ---
        const confettiContainer = document.getElementById('confettiContainer');
        const submitThoughtButton = document.getElementById('submit-thought-button');
        const submitWishButton = document.getElementById('submit-wish-button');


        // --- localStorage Functions ---
        function loadEntriesFromStorage() {
            const storedEntries = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedEntries) {
                try {
                    const parsedEntries = JSON.parse(storedEntries);
                    // Basic validation
                    if (Array.isArray(parsedEntries) && parsedEntries.every(e => typeof e.text === 'string' && typeof e.name === 'string' && typeof e.isFact === 'boolean' && typeof e.type === 'string')) {
                        return parsedEntries;
                    } else {
                        console.warn("Stored data format mismatch or invalid. Resetting to defaults.");
                        return [...STARTER_ENTRIES];
                    }
                } catch (error) {
                    console.error("Error parsing stored entries:", error, "Resetting to defaults.");
                    return [...STARTER_ENTRIES];
                }
            }
            return [...STARTER_ENTRIES];
        }

        function saveEntriesToStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(collectedEntries));
            } catch (error) {
                 console.error("Error saving entries to localStorage:", error);
                 alert("Could not save your progress. Local storage might be full or disabled.");
            }
        }

        function clearStoredEntries() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
        }


        // --- Initial Setup ---
        window.onload = function() {
            collectedEntries = loadEntriesFromStorage();
            saveEntriesToStorage(); // Ensure defaults or loaded data is saved back
            populateFunFacts();
            populateFactWall(); // Populate the main wall on load
            updateScoreDisplay();
            updateBuildResourcesDisplay(); // Initialize build section displays
            updateEnergyCollectedDisplay();
            showSection('intro'); // Start at the intro
        };

        // --- Core Functions ---

        function populateFunFacts() {
            funFactsList.innerHTML = ''; // Clear existing
            DYSON_FUN_FACTS.forEach(fact => {
                const li = document.createElement('li');
                li.textContent = fact;
                funFactsList.appendChild(li);
            });
        }

        function populateFactWall() {
            factWall.innerHTML = ''; // Clear existing
            collectedEntries.forEach(entry => addEntryToWall(factWall, entry));
        }

        function populateCollectedQuestions() {
             collectedQuestionsList.innerHTML = ''; // Clear existing
             const questionsAndThoughts = collectedEntries.filter(entry => entry.type === 'thought');
             questionsAndThoughts.forEach(entry => addEntryToWall(collectedQuestionsList, entry));
        }

         function populateCollectedWishes() {
             collectedWishesList.innerHTML = ''; // Clear existing
             const wishes = collectedEntries.filter(entry => entry.type === 'wish');
             wishes.forEach(entry => addEntryToWall(collectedWishesList, entry));
         }

        function addEntryToWall(listElement, entry) {
            const li = document.createElement('li');
            li.innerHTML = `${entry.text} <span class="fact-attribution">- ${entry.name} (${getEntryTypeLabel(entry)})</span>`;
            if (entry.type === 'wish') {
                li.classList.add('wish');
            } else if (!entry.isFact) {
                 li.classList.add('not-fact');
            }
            listElement.insertBefore(li, listElement.firstChild); // Prepend for newest first
        }

        function getEntryTypeLabel(entry) {
            if (entry.type === 'wish') return 'Wish';
            if (entry.isFact) return 'Fact';
            return 'Thought/Idea';
        }


        function showSection(sectionId) {
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            const element = document.getElementById(sectionId);
            if (element) {
                element.classList.add('active');
            } else {
                console.error("Section not found:", sectionId);
                return;
            }

             // Clear build feedback when leaving the build section or entering it
             if (buildFeedback) {
                buildFeedback.innerHTML = '<p>Awaiting your command, Commander!</p>';
                buildFeedback.className = 'build-feedback'; // Reset style
             }

            const sections = ['intro', 'fun-facts', 'concept', 'feasibility', 'importance', 'build', 'share-thoughts', 'collected-questions', 'collected-wishes', 'conclusion'];
            const currentIndex = sections.indexOf(sectionId);
            const progressPercent = (currentIndex / (sections.length - 1)) * 100;
            progressBar.style.width = progressPercent + '%';

            // Update visuals or data specific to the section
            updateCosmicVisuals(sectionId); // Handles visuals for concept, feasibility, importance, build

            if (sectionId === 'build') {
                updateBuildResourcesDisplay(); // Ensure points display is correct
                updateBuildButtons();          // Ensure button states are correct
                updateEnergyCollectedDisplay(); // Ensure efficiency display is correct
                // Visual update handled by updateCosmicVisuals call above
            }
            if (sectionId === 'collected-questions') {
                 populateCollectedQuestions();
            }
             if (sectionId === 'collected-wishes') {
                 populateCollectedWishes();
            }
             if (sectionId === 'conclusion') {
                 finalizeResults();
            }
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = score;
            scoreDisplay.classList.add('resource-animation');
            setTimeout(() => scoreDisplay.classList.remove('resource-animation'), 500);
        }

        // --- Build Section Specific Functions (NEW/MODIFIED) ---

        function updateBuildResourcesDisplay() {
            // Update both the label and the counter in the results area
            const pointsText = currentResources;
            if(resourcesBuildDisplay) resourcesBuildDisplay.textContent = pointsText; // Update label above
            if(resourcesBuild) resourcesBuild.textContent = pointsText; // Update counter below
            // Animate the counter
            if(resourcesBuild) {
                resourcesBuild.classList.add('resource-animation');
                setTimeout(() => resourcesBuild.classList.remove('resource-animation'), 500);
            }
        }

        function updateEnergyCollectedDisplay() {
            // Slightly adjusted calculation for more impact from phases
            // Max efficiency capped at 100%
             let calculatedEnergy = Math.min(100,
                 (buildAllocations.phase1 * 10) + // Collectors provide base gathering
                 (buildAllocations.phase2 * 25) + // Converters significantly boost usable energy
                 (buildAllocations.phase3 * 8) + // Relays help slightly with overall efficiency
                 (buildAllocations.phase4 * 5)   // Stabilizers add a small reliability bonus
             );
            energyCollected = Math.round(calculatedEnergy);
            if(energyCollectedDisplay) energyCollectedDisplay.textContent = energyCollected; // Just the number, % is in HTML
        }

        // NEW Function: runMissionPhase
        function runMissionPhase(phase, cost) {
             if (currentResources >= cost) {
                currentResources -= cost;
                buildAllocations[phase] = (buildAllocations[phase] || 0) + 1; // Increment phase count

                // Update Displays
                updateBuildResourcesDisplay();
                updateEnergyCollectedDisplay();
                updateBuildButtons(); // Disable buttons if needed

                // Give Feedback
                let feedbackMsg = "";
                buildFeedback.className = 'build-feedback success'; // Default to success style
                let panelsToAdd = 0;
                let pointsEarned = 0;

                switch (phase) {
                    case 'phase1':
                        feedbackMsg = `<strong>Phase 1 Complete!</strong> Basic collector swarm deployed. We're gathering sunlight! <span class="sparkle">‚òÄÔ∏è</span>`;
                        panelsToAdd = 1;
                        pointsEarned = 5;
                        break;
                    case 'phase2':
                        feedbackMsg = `<strong>Phase 2 Complete!</strong> Power converters online. Usable energy output increased significantly! <span class="sparkle">‚ö°</span>`;
                        panelsToAdd = 2; // More visual impact
                        pointsEarned = 8;
                        break;
                    case 'phase3':
                        feedbackMsg = `<strong>Phase 3 Complete!</strong> Relay stations active. Power transmission pathways established! <span class="sparkle">üì°</span>`;
                         panelsToAdd = 1;
                         pointsEarned = 4;
                        break;
                    case 'phase4':
                        feedbackMsg = `<strong>Phase 4 Complete!</strong> Orbit stabilizers engaged. The swarm is more stable and reliable! <span class="sparkle">üõ°Ô∏è</span>`;
                         panelsToAdd = 1;
                         pointsEarned = 6;
                        break;
                 }
                 buildFeedback.innerHTML = `<p>${feedbackMsg}</p>`;
                 addPanelToVisual(panelsToAdd); // Add visual panels
                 score += pointsEarned; // Award points
                 updateScoreDisplay();

             } else {
                 buildFeedback.innerHTML = "<p>Mission Control reports insufficient Design Points for that phase!</p>";
                 buildFeedback.className = 'build-feedback info'; // Use info style for this message
             }
        }

        function updateBuildButtons() {
            // Now checks buttons based on their ID and associated cost from the HTML onclick
            document.querySelectorAll('.build-choices .build-btn').forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                // Basic parsing to find the cost argument in runMissionPhase('phase', cost)
                const match = onclickAttr?.match(/runMissionPhase\('[^']+',\s*(\d+)\)/);
                if (match && match[1]) {
                    const cost = parseInt(match[1]);
                    button.disabled = currentResources < cost;
                } else {
                     button.disabled = false; // Fallback
                     console.warn("Could not determine cost for button:", button.id);
                }
            });
        }

        // Modified addPanelToVisual to accept a count
        function addPanelToVisual(count = 1) { // Default to adding 1 panel
            const container = document.getElementById('buildContainer');
            if (!container) return;
            const panelCount = container.querySelectorAll('.cosmic-panel').length;
             if (panelCount >= MAX_PANELS) return; // Don't add more than max

            const panelsToAdd = Math.min(count, MAX_PANELS - panelCount); // Don't exceed MAX_PANELS
            addMorePanels(container, panelsToAdd); // Use the generalized function
        }

        // --- End of Build Section Specific Functions ---


        // --- Quiz and Submission Functions (Mostly Unchanged) ---

        function selectOption(element, questionId, isCorrect) {
            if (sectionState[questionId].answered) return;
            sectionState[questionId].answered = true;

            const feedbackElement = document.getElementById(`${questionId}-feedback`);
            const optionsContainer = document.getElementById(`${questionId}-options`);
            const nextButton = document.getElementById(`${questionId}-next`);

            optionsContainer.querySelectorAll('.option').forEach(opt => {
                opt.onclick = null; // Disable clicking
                opt.classList.add('disabled');
                if (opt !== element) opt.style.opacity = '0.6'; // Dim unselected options
            });

            element.classList.add('selected'); // Highlight the selected option

            if (isCorrect) {
                score += 10;
                element.classList.add('correct');
                feedbackElement.innerHTML = `<p><strong>Correct!</strong> ${getFeedbackText(questionId, true)}</p>`;
                feedbackElement.className = 'feedback correct';
            } else {
                score += 2;
                element.classList.add('incorrect');
                feedbackElement.innerHTML = `<p><strong>Not quite!</strong> ${getFeedbackText(questionId, false)}</p>`;
                feedbackElement.className = 'feedback incorrect';
                // Highlight the correct answer
                optionsContainer.querySelectorAll('.option').forEach(opt => {
                    const onclickAttr = opt.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(', true)')) {
                        opt.classList.add('correct');
                        opt.style.opacity = '1';
                    }
                });
            }

            updateScoreDisplay();
            nextButton.style.display = 'inline-block'; // Show the next button
        }

        function getFeedbackText(questionId, isCorrect) {
            switch (questionId) {
                case 'concept': return isCorrect ? "Dyson proposed a 'swarm' of collectors. A solid shell is likely unstable!" : "While sci-fi loves solid shells, Dyson proposed a 'swarm' of many collectors. A solid shell would face huge gravitational stress!";
                case 'feasibility': return isCorrect ? "Exactly! The sheer amount of material needed is staggering - maybe needing entire planets!" : "While other factors are tricky, getting enough *stuff* (materials) is the biggest hurdle. We might need to dismantle planets!";
                case 'importance': return isCorrect ? "Right! It represents the ultimate energy goal for advanced civilizations and could be a sign of alien life (technosignature)." : "The main idea is capturing nearly ALL a star's energy. It's also a potential 'technosignature' ‚Äì a sign of advanced alien tech.";
                default: return "";
            }
        }

        function submitThought() {
             const thoughtText = sharedThoughtInput.value.trim();
             const isNotFact = sharedFactCheck.checked;

             if (thoughtText) {
                 const currentName = nameInput.value.trim() || userName; // Use name if entered, else default
                 const newEntry = {
                     text: thoughtText,
                     name: currentName,
                     isFact: !isNotFact,
                     type: 'thought' // Mark as thought/question/fact
                 };

                 collectedEntries.unshift(newEntry); // Add to start of array
                 addEntryToWall(factWall, newEntry); // Add visually to the main wall immediately
                 saveEntriesToStorage(); // Save updated array

                 sharedThoughtInput.value = ''; // Clear input
                 sharedFactCheck.checked = false;
                 sectionState.thoughtSubmitted = true; // Mark as submitted for this session

                 const originalText = submitThoughtButton.textContent;
                 submitThoughtButton.textContent = 'Added!';
                 setTimeout(() => {
                     submitThoughtButton.textContent = originalText;
                 }, 1500);

                 score += 5; // Award points for contribution
                 updateScoreDisplay();
             } else {
                 alert("Please share a thought or fact first!");
             }
        }

        function submitBirthdayWish() {
             if (sectionState.wishSubmitted) {
                 alert("You've already submitted your wish!");
                 return;
             }

             const wishText = birthdayWishInput.value.trim();
             const finalName = nameInput.value.trim();

             if (!finalName) {
                 alert("Please enter your name to sign your wish!");
                 return;
             }
             userName = finalName; // Update the stored username
             displayName.textContent = userName; // Update display immediately

             if (!wishText) {
                 alert("Please write a birthday wish for Mary!");
                 return;
             }

             const newEntry = {
                 text: wishText,
                 name: userName,
                 isFact: false, // Wishes are not facts
                 type: 'wish' // Mark as a wish
             };

             collectedEntries.unshift(newEntry); // Add to the beginning of the main list
             addEntryToWall(factWall, newEntry); // Add visually to the main wall
             addEntryToWall(collectedWishesList, newEntry); // Also add to the dedicated wishes list if currently viewed
             saveEntriesToStorage(); // Save updated array

             birthdayWishInput.value = ''; // Clear the input field
             sectionState.wishSubmitted = true; // Mark wish as submitted for this session

             submitWishButton.textContent = "Wish Submitted!";
             submitWishButton.disabled = true;

             score += 10; // Bonus points for birthday wish!
             updateScoreDisplay();
             startConfetti(); // Celebrate!
        }

        function finalizeResults() {
            finalScoreDisplay.textContent = score;
            finalEnergyDisplay.textContent = energyCollected; // Display the final efficiency
            displayName.textContent = nameInput.value.trim() || userName;
            populateFactWall(); // Ensure the main wall on the conclusion page is fully up-to-date
        }


        function restartGame() {
            clearStoredEntries(); // Clear localStorage
            // Reset state variables
            score = 0;
            currentResources = 100;
            energyCollected = 0;
            userName = "Explorer";
            buildAllocations = { phase1: 0, phase2: 0, phase3: 0, phase4: 0 }; // Reset allocations
            collectedEntries = [...STARTER_ENTRIES];
            saveEntriesToStorage();

            // Reset section-specific states
            sectionState = {
                'concept': { answered: false },
                'feasibility': { answered: false },
                'importance': { answered: false },
                'thoughtSubmitted': false,
                'wishSubmitted': false
            };

            // Reset UI elements
            updateScoreDisplay();
            updateBuildResourcesDisplay();
            updateEnergyCollectedDisplay();
            nameInput.value = '';
            birthdayWishInput.value = '';
            sharedThoughtInput.value = '';
            sharedFactCheck.checked = false;
            displayName.textContent = userName;

            // Reset question sections UI
            ['concept', 'feasibility', 'importance'].forEach(id => {
                const feedbackEl = document.getElementById(`${id}-feedback`);
                const nextBtn = document.getElementById(`${id}-next`);
                const optionsContainer = document.getElementById(`${id}-options`);

                if(feedbackEl) {
                    feedbackEl.style.display = 'none';
                    feedbackEl.innerHTML = '';
                }
                 if(nextBtn) nextBtn.style.display = 'none';

                if(optionsContainer) {
                    optionsContainer.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                        opt.style.opacity = '1';
                        // Re-attach onclick handlers
                        const onclickAttr = opt.getAttribute('onclick');
                        const match = onclickAttr?.match(/selectOption\(this,\s*'([^']*)',\s*(true|false)\)/);
                        if (match) {
                            const questionId = match[1];
                            const isCorrect = match[2] === 'true';
                            opt.onclick = () => selectOption(opt, questionId, isCorrect);
                        } else {
                            console.warn("Could not re-attach onclick for option:", opt);
                        }
                    });
                }
            });

            // Reset Build Section UI
            updateBuildButtons(); // Re-enable buttons based on initial resources
            if (buildFeedback) { // Clear feedback message
                 buildFeedback.innerHTML = '<p>Awaiting your command, Commander!</p>';
                 buildFeedback.className = 'build-feedback';
            }
             clearCosmicVisuals('buildContainer'); // Clear panels from build visual
             updateCosmicVisuals('build'); // Re-initialize build visual (star only)

            // Reset thought/wish submission buttons
            submitThoughtButton.textContent = 'Add to Collection';
            submitWishButton.textContent = 'Add Your Wish & Celebrate!';
            submitWishButton.disabled = false;

            // Clear dynamic lists
            factWall.innerHTML = '';
            collectedQuestionsList.innerHTML = '';
            collectedWishesList.innerHTML = '';

            // Refresh Wall and Start Over
            populateFactWall();
            stopConfetti();
            showSection('intro');
        }

        // --- Mailto Function (Optional - can be uncommented if needed) ---
        /*
        function generateMailtoLink() {
            // IMPORTANT: Replace "YOUR_EMAIL_ADDRESS_HERE@example.com"
            const recipientEmail = "jessesrothman@gmail.com"; // <<< EDIT THIS EMAIL ADDRESS

            const finalName = nameInput.value.trim() || userName;
            const finalScore = score;
            const finalEnergy = energyCollected;
            const currentEntries = loadEntriesFromStorage(); // Load fresh data

            let emailBody = `Cosmic Curiosity Results for Mary!\n`;
            emailBody += `Submitted by: ${finalName}\n\n`;
            emailBody += `Final Fun Points: ${finalScore}\n`;
            emailBody += `Blueprint Efficiency: ${finalEnergy}%\n\n`; // Updated label
            emailBody += `--- All Contributions ---\n\n`;

            if (currentEntries.length > 0) {
                for (let i = currentEntries.length - 1; i >= 0; i--) { // Oldest first
                    const entry = currentEntries[i];
                    emailBody += `"${entry.text}" - ${entry.name} (${getEntryTypeLabel(entry)})\n\n`;
                }
            } else {
                emailBody += "(No facts, thoughts, or wishes were submitted)\n";
            }

            const emailSubject = `Cosmic Curiosity Results from ${finalName}`;
            const encodedSubject = encodeURIComponent(emailSubject);
            const encodedBody = encodeURIComponent(emailBody);
            const mailtoLink = `mailto:${recipientEmail}?subject=${encodedSubject}&body=${encodedBody}`;

            const MAX_MAILTO_LENGTH = 2000;
            if (mailtoLink.length > MAX_MAILTO_LENGTH) {
                alert("Warning: The collected results are very long and might exceed email link limits.");
            }

            try {
                 window.location.href = mailtoLink;
            } catch (e) {
                 console.error("Failed to open mailto link:", e);
                 alert("Could not open your email app automatically.");
            }
        }
        */


        // --- Visual Effect Functions ---
        function updateCosmicVisuals(sectionId) {
            // Clear previous visuals before adding new ones for the current section
             ['conceptContainer', 'feasibilityContainer', 'importanceContainer', 'buildContainer'].forEach(id => {
                 if (id !== `${sectionId}Container`) { // Don't clear the container we are about to draw in
                     clearCosmicVisuals(id);
                 }
             });

             const container = document.getElementById(`${sectionId}Container`);
             if (!container) return; // Exit if the section doesn't have a visual container

             // Ensure the star is always present in its container
             if (!container.querySelector('.star')) {
                 const star = document.createElement('div');
                 star.className = 'star';
                 container.appendChild(star);
             }

             // Add elements based on the current section
             switch (sectionId) {
                 case 'concept':
                     // Just the star (already ensured above)
                     break;
                 case 'feasibility':
                     addCosmicRing(container);
                     break;
                 case 'importance':
                     addCosmicRing(container);
                     addMorePanels(container, 5); // Add a few initial panels
                     break;
                 case 'build':
                     // Re-create the visual based on current buildAllocations
                     completeDysonSwarmVisual(container);
                     break;
             }
        }

        function clearCosmicVisuals(containerId) {
             const container = document.getElementById(containerId);
             if (container) {
                 // Remove only rings and panels, keep the star if it exists
                 const elementsToRemove = container.querySelectorAll('.cosmic-ring, .cosmic-panel');
                 elementsToRemove.forEach(el => el.remove());
             }
        }

        function addCosmicRing(targetContainer) {
             if (!targetContainer || targetContainer.querySelector('.cosmic-ring')) return; // Don't add if exists
             const ring = document.createElement('div');
             ring.className = 'cosmic-ring';
             targetContainer.appendChild(ring);
             void ring.offsetWidth; // Trigger reflow for animation
             ring.style.opacity = '1'; // Make it visible
        }

        function addMorePanels(targetContainer, count) {
            if (!targetContainer) return;
            if (!targetContainer.querySelector('.cosmic-ring')) {
                addCosmicRing(targetContainer); // Ensure ring exists
            }
            const radius = 75; // Radius of the ring inner edge for panel placement
            const existingPanels = targetContainer.querySelectorAll('.cosmic-panel').length;

            for (let i = 0; i < count; i++) {
                 if (existingPanels + i >= MAX_PANELS) break; // Stop if max panels reached

                const panelIndex = existingPanels + i;
                 // Distribute panels somewhat evenly, allowing for MAX_PANELS total
                const angle = (panelIndex / Math.max(1, MAX_PANELS)) * 2 * Math.PI + (Math.random() * 0.3 - 0.15); // Add slight randomness
                const x = radius * Math.cos(angle);
                const y = radius * Math.sin(angle);

                const panel = document.createElement('div');
                panel.className = 'cosmic-panel';
                 // Position and rotate panel to face outwards
                panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(0.1)`;
                panel.style.opacity = '0'; // Start invisible and scaled down

                targetContainer.appendChild(panel);

                 // Animate appearance
                 setTimeout(() => {
                     panel.style.opacity = '0.7';
                     panel.style.transform = `translate(${x}px, ${y}px) rotate(${angle + Math.PI / 2}rad) scale(1)`;
                 }, 50 * i); // Stagger appearance slightly
            }
        }

        // Used to draw the state of the swarm in the 'build' section
        function completeDysonSwarmVisual(targetContainer) {
            if (!targetContainer) return;
            clearCosmicVisuals(targetContainer.id); // Clear existing panels/rings first
            addCosmicRing(targetContainer); // Add the ring

            // Calculate how many panels to show based on phases completed
            // Give more visual weight to collectors and converters
            const numPanels = Math.min(MAX_PANELS,
                 (buildAllocations.phase1 * 2) + // 2 panels per collector phase
                 (buildAllocations.phase2 * 3) + // 3 panels per converter phase
                 (buildAllocations.phase3 * 1) + // 1 panel per relay phase
                 (buildAllocations.phase4 * 1)   // 1 panel per stabilizer phase
             );

            addMorePanels(targetContainer, numPanels); // Add the calculated number of panels
        }

        // --- Confetti Functions ---
        let confettiInterval = null;
        function startConfetti() { stopConfetti(); createConfettiPiece(); confettiInterval = setInterval(createConfettiPiece, 100); setTimeout(stopConfetti, 5000); }
        function stopConfetti() { clearInterval(confettiInterval); confettiInterval = null; setTimeout(() => { if (confettiContainer) confettiContainer.innerHTML = ''; }, 3000); }
        function createConfettiPiece() { if (!confettiContainer) return; const confetti = document.createElement('div'); const randomClass = `c${Math.floor(Math.random() * 5)}`; confetti.className = `confetti ${randomClass}`; confetti.style.left = `${Math.random() * 100}vw`; confetti.style.animationDelay = `${Math.random() * 2}s`; confetti.style.transform = `rotate(${Math.random() * 360}deg)`; confettiContainer.appendChild(confetti); setTimeout(() => { confetti.remove(); }, 7000); }

    </script>
</body>
</html>
